name: DevSecOps Agentic AI Pipeline (Enterprise Optimize)

on:
  push:
    branches: [test-home-sachin]
  workflow_dispatch:

concurrency:
  group: devsecops-${{ github.ref }}
  cancel-in-progress: true

# ðŸ”§ Recommended for AutoFix + PR job
permissions:
  contents: write
  pull-requests: write

env:
  JAVA_VERSION: "17"
  PYTHON_VERSION: "3.12"
  APP_DIR: "enterprise-devsecops-hackathon"
  REPORTS_DIR: "reports"
  MIN_SEVERITY: "high"
  OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
  LLM_ENABLED: "true"
  LLM_EXPLAIN: "0"
  LLM_MODE: "openai"

jobs:

  # ============================================================
  # BUILD
  # ============================================================
  Build-Java-App:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: ${{ env.JAVA_VERSION }}
          cache: maven

      - run: mvn -B clean package -DskipTests -f $APP_DIR/app/pom.xml

      - uses: actions/upload-artifact@v4
        with:
          name: app-jar
          path: ${{ env.APP_DIR }}/app/target/enterprise-app-1.0.jar
          retention-days: 7

  # ============================================================
  # SAST
  # ============================================================
  SAST-Scanning:
    runs-on: ubuntu-latest
    continue-on-error: true
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: ${{ env.JAVA_VERSION }}
      - uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - run: mkdir -p $REPORTS_DIR

      - run: mvn -B clean package -DskipTests -f $APP_DIR/app/pom.xml

      - run: |
          pip install semgrep
          semgrep scan \
            --config=p/java \
            --config=p/owasp-top-ten \
            --json \
            --output $REPORTS_DIR/semgrep.json \
            $APP_DIR/app/src/main/java || echo '{}' > $REPORTS_DIR/semgrep.json

      - name: Run SpotBugs
        run: |
          mvn -B verify spotbugs:spotbugs -f $APP_DIR/app/pom.xml || true
      
      - name: Collect SpotBugs XML
        run: |
          if [ -f "$APP_DIR/app/target/spotbugsXml.xml" ]; then
            cp "$APP_DIR/app/target/spotbugsXml.xml" reports/spotbugs.xml
          else
            echo "<BugCollection/>" > reports/spotbugs.xml
          fi
      
      - name: Convert SpotBugs XML â†’ JSON
        run: |
          pip install xmltodict
          cat <<'EOF' > convert_spotbugs.py
          import xmltodict, json, pathlib
          p = pathlib.Path("reports/spotbugs.xml")
          if p.exists():
              data = xmltodict.parse(p.read_text())
              pathlib.Path("reports/spotbugs.json").write_text(json.dumps(data, indent=2))
          else:
              pathlib.Path("reports/spotbugs.json").write_text("{}")
          EOF
          python convert_spotbugs.py

      - uses: actions/upload-artifact@v4
        with:
          name: sast-reports
          path: reports/*.json
          if-no-files-found: ignore

  # # ============================================================
  # # SECRETS
  # # ============================================================
  # Secrets-Scanning:
  #   runs-on: ubuntu-latest
  #   continue-on-error: true
  #   steps:
  #     - uses: actions/checkout@v4
  #     - run: mkdir -p $REPORTS_DIR
  #     - run: sudo apt-get update && sudo apt-get install -y jq
  #     - run: |
  #         VERSION=$(curl -s https://api.github.com/repos/gitleaks/gitleaks/releases/latest | jq -r .tag_name)
  #         curl -L -o gitleaks.tar.gz https://github.com/gitleaks/gitleaks/releases/download/${VERSION}/gitleaks_${VERSION#v}_linux_x64.tar.gz
  #         tar -xzf gitleaks.tar.gz && sudo mv gitleaks /usr/local/bin/
  #     - run: |
  #         gitleaks detect --source . --report-format json \
  #         --report-path $REPORTS_DIR/gitleaks.json || echo '{}' > $REPORTS_DIR/gitleaks.json
  #     - uses: actions/upload-artifact@v4
  #       with:
  #         name: secrets-reports
  #         path: reports/*.json
  #         if-no-files-found: ignore

  # # # ============================================================
  # # # SCA
  # # # ============================================================
  # SCA-Scanning:
  #   runs-on: ubuntu-latest
  #   continue-on-error: true
  #   steps:
  #     - uses: actions/checkout@v4
  #     - run: mkdir -p $REPORTS_DIR
  #     - run: |
  #         curl -sfL https://raw.githubusercontent.com/aquasecurity/trivy/main/contrib/install.sh | sh
  #         ./bin/trivy fs --format json --output $REPORTS_DIR/trivy_fs.json \
  #         $APP_DIR || echo '{}' > $REPORTS_DIR/trivy_fs.json
  #     - uses: actions/upload-artifact@v4
  #       with:
  #         name: sca-reports
  #         path: reports/*.json

  # # # ============================================================
  # # # IAC
  # # # ============================================================
  # IAC-Scanning:
  #   runs-on: ubuntu-latest
  #   continue-on-error: true
  #   steps:
  #     - uses: actions/checkout@v4
  #     - run: mkdir -p $REPORTS_DIR
  #     - run: |
  #         curl -L https://github.com/aquasecurity/tfsec/releases/latest/download/tfsec-linux-amd64 -o tfsec
  #         chmod +x tfsec && sudo mv tfsec /usr/local/bin/
  #     - run: |
  #         tfsec $APP_DIR/terraform --format json > "$REPORTS_DIR/tfsec.json" || true
  #     - uses: actions/upload-artifact@v4
  #       with:
  #         name: iac-reports
  #         path: reports/*.json

  # # # ============================================================
  # # # CONTAINER
  # # # ============================================================
  # Container-Scanning:
  #   runs-on: ubuntu-latest
  #   needs: Build-Java-App
  #   continue-on-error: true
  #   steps:
  #     - uses: actions/checkout@v4
  #     - uses: actions/download-artifact@v4
  #       with:
  #         name: app-jar
  #         path: ${{ env.APP_DIR }}/app/target
  #     - name: Verify jar
  #       run: |
  #         echo "Listing target folder:"
  #         ls -la $APP_DIR/app/target
  #         if [ ! -f "$APP_DIR/app/target/enterprise-app-1.0.jar" ]; then
  #           echo "âŒ JAR missing"
  #           exit 1
  #         fi
  #     - run: mkdir -p $REPORTS_DIR
  #     - name: Build Docker image
  #       run: |
  #         docker build \
  #           -t enterprise-app \
  #           -f $APP_DIR/docker/Dockerfile \
  #           .
  #     - name: Install Trivy
  #       run: |
  #         curl -sfL https://raw.githubusercontent.com/aquasecurity/trivy/main/contrib/install.sh | sh
  #     - name: Trivy Image Scan
  #       run: |
  #         ./bin/trivy image enterprise-app \
  #           --format json \
  #           --output $REPORTS_DIR/trivy_image.json \
  #           || echo '{}' > $REPORTS_DIR/trivy_image.json
  #     - uses: actions/upload-artifact@v4
  #       with:
  #         name: container-reports
  #         path: reports/*.json
  #         if-no-files-found: ignore

  # # ============================================================
  # # DAST
  # # ============================================================
  # DAST-Scanning:
  #   runs-on: ubuntu-latest
  #   needs: Build-Java-App
  #   continue-on-error: true
  #   steps:
  #     - uses: actions/checkout@v4
  #     - uses: actions/download-artifact@v4
  #       with:
  #         name: app-jar
  #         path: ${{ env.APP_DIR }}/app/target
  #     - run: mkdir -p $REPORTS_DIR
  #     - name: Start Application
  #       run: |
  #         mkdir -p config/dummy
  #         java -jar $APP_DIR/app/target/enterprise-app-1.0.jar \
  #           --spring.config.import=optional:file:./config/*/ &
  #         sleep 40
  #     - name: OWASP ZAP Baseline
  #       run: |
  #         mkdir -p zap-output
  #         docker run --rm \
  #           -u root \
  #           --network=host \
  #           -v $(pwd)/zap-output:/zap/wrk:rw \
  #           ghcr.io/zaproxy/zaproxy:stable \
  #           zap-baseline.py \
  #           -t http://localhost:8080 \
  #           -J zap.json || true
  #         if [ -f zap-output/zap.json ]; then
  #           mv zap-output/zap.json $REPORTS_DIR/zap.json
  #         else
  #           echo '{}' > $REPORTS_DIR/zap.json
  #         fi
  #     - uses: actions/upload-artifact@v4  
  #       with:
  #         name: dast-reports
  #         path: reports/*.json
  #         if-no-files-found: ignore

# ============================================================
# AGGREGATE
# ============================================================
  Aggregate-Scanning-Reports:
    runs-on: ubuntu-latest
    needs: [SAST-Scanning]
    # needs: [SAST-Scanning,Secrets-Scanning,SCA-Scanning,IAC-Scanning,Container-Scanning,DAST-Scanning]
    if: always()
    steps:
      - uses: actions/download-artifact@v4
        with:
          path: collected-reports

      - run: |
          mkdir -p final-reports
          find collected-reports -name "*.json" -exec cp {} final-reports/ \; || true

          echo "DEBUG: Aggregated files"
          ls -la final-reports || true

      - uses: actions/upload-artifact@v4
        with:
          name: all-scan-reports
          path: final-reports/*.json

# ============================================================
# AI GATE
# ============================================================
  AI-Gate-Analysis:
    runs-on: ubuntu-latest
    needs: Aggregate-Scanning-Reports
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - run: pip install -r requirements.txt

      - uses: actions/download-artifact@v4
        with:
          name: all-scan-reports
          path: reports

      - run: mkdir -p agent_output

      - run: |
          python main.py --reports-dir reports --output-dir agent_output --mode=gate --skip-llm

      - name: Debug Gate Output
        run: |
          echo "DEBUG decision.json"
          cat agent_output/decision.json || true
          echo "DEBUG files"
          ls -la agent_output || true

      - uses: actions/upload-artifact@v4
        with:
          name: ai-results
          path: agent_output/

# ============================================================
# SECURITY GATE
# ============================================================
  Security-Gate:
    runs-on: ubuntu-latest
    needs: AI-Gate-Analysis
    outputs:
      gate_failed: ${{ steps.read.outputs.gate_failed }}
    steps:
      - uses: actions/download-artifact@v4
        with:
          name: ai-results
          path: agent_output

      - run: sudo apt-get update && sudo apt-get install -y jq

      - id: read
        run: |
          STATUS=$(jq -r '.decision' agent_output/decision.json)
          echo "DEBUG Gate decision = $STATUS"
          if [ "$STATUS" = "FAIL" ]; then
            echo "gate_failed=true" >> $GITHUB_OUTPUT
          else
            echo "gate_failed=false" >> $GITHUB_OUTPUT
          fi

# ============================================================
# TRIAGE
# ============================================================
  LLM-Triage:
    runs-on: ubuntu-latest
    needs: Security-Gate
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - run: pip install -r requirements.txt

      - uses: actions/download-artifact@v4
        with:
          name: all-scan-reports
          path: reports

      - uses: actions/download-artifact@v4
        with:
          name: ai-results
          path: agent_output

      - run: |
          python main.py --reports-dir reports --output-dir agent_output --mode=triage

      - name: Debug triage
        run: |
          echo "DEBUG triage output"
          ls -la agent_output
          cat agent_output/* || true

      - uses: actions/upload-artifact@v4
        with:
          name: triage-output
          path: agent_output/

# ============================================================
# SUGGESTIONS
# ============================================================
  LLM-Suggestions:
    runs-on: ubuntu-latest
    needs: LLM-Triage
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - run: pip install -r requirements.txt

      - uses: actions/download-artifact@v4
        with:
          name: triage-output
          path: agent_output

      - uses: actions/download-artifact@v4
        with:
          name: all-scan-reports
          path: reports

      - run: |
          python main.py --reports-dir reports --output-dir agent_output --mode=advise

      - name: Debug suggestions
        run: |
          echo "DEBUG suggestions"
          ls -la agent_output
          cat agent_output/* || true

      - uses: actions/upload-artifact@v4
        with:
          name: suggestions-output
          path: agent_output/

      # - name: Setup Git identity
      #   run: |
      #     git config --global user.name "github-actions"
      #     git config --global user.email "actions@github.com"
      
      # - name: Install GitHub CLI
      #   run: |
      #     sudo apt-get update
      #     sudo apt-get install gh -y
      
      # - name: Authenticate gh
      #   run: |
      #     echo "${{ secrets.GITHUB_TOKEN }}" | gh auth login --with-token



# ============================================================
# AUTOFIX
# ============================================================
  AutoFix-PR:
    runs-on: ubuntu-latest
    needs: [LLM-Suggestions, Security-Gate]
    if: needs.Security-Gate.outputs.gate_failed == 'true'
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
  
      - uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
  
      - run: pip install -r requirements.txt
  
      - uses: actions/download-artifact@v4
        with:
          name: suggestions-output
          path: agent_output
  
      - uses: actions/download-artifact@v4
        with:
          name: all-scan-reports
          path: reports
  
      # â­ REQUIRED (identity per job)
      - name: Setup Git identity
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"
  
      # â­ REQUIRED (gh CLI)
      - name: Install GitHub CLI
        run: |
          sudo apt-get update
          sudo apt-get install gh -y
  
      # â­ REQUIRED (auth)  ## In GitHub Actions you DO NOT need gh auth login at all if you are using the GITHUB_TOKEN secret, as GitHub Actions automatically authenticates the GitHub CLI with that token. You can directly use gh commands without any additional authentication steps.
      # - name: Authenticate gh
      #   env:
      #     GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      #   run: |
      #     echo "$GH_TOKEN" | gh auth login --with-token

      ## To Debug authentication issue.
      - name: Verify gh auth
        run: |
          gh auth status
  
      - run: |
          python main.py --reports-dir reports --output-dir agent_output --mode=fix --skip-llm

      # â­ Debug patch manifest (place here)
      - name: Debug patch manifest
        run: |
          echo "Patch manifest"
          cat agent_output/patch_manifest.json || true
  
      - name: Debug autofix
        run: |
          git status
          git branch -a
          ls -la agent_output
  
      - uses: actions/upload-artifact@v4
        with:
          name: autofix-output
          path: agent_output/

  # AutoFix-PR:
  #   runs-on: ubuntu-latest
  #   needs: [LLM-Suggestions, Security-Gate]
  #   if: needs.Security-Gate.outputs.gate_failed == 'true'
  #   steps:
  #     - uses: actions/checkout@v4
  #     - uses: actions/setup-python@v5
  #       with:
  #         python-version: ${{ env.PYTHON_VERSION }}

  #     - run: pip install -r requirements.txt

  #     - uses: actions/download-artifact@v4
  #       with:
  #         name: suggestions-output
  #         path: agent_output

  #     - uses: actions/download-artifact@v4
  #       with:
  #         name: all-scan-reports
  #         path: reports

  #     - run: |
  #         python main.py --reports-dir reports --output-dir agent_output --mode=fix --skip-llm

  #     - name: Debug autofix
  #       run: |
  #         echo "DEBUG autofix"
  #         ls -la agent_output
  #         cat agent_output/* || true

  #     - uses: actions/upload-artifact@v4
  #       with:
  #         name: autofix-output
  #         path: agent_output/



# name: DevSecOps Agentic AI Pipeline (Enterprise Optimize)

# on:
#   push:
#     branches: [test-home-sachin]
#   workflow_dispatch:

# concurrency:
#   group: devsecops-${{ github.ref }}
#   cancel-in-progress: true

# # ðŸ”§ Recommended for AutoFix + PR job
# permissions:
#   contents: write
#   pull-requests: write

# env:
#   JAVA_VERSION: "17"
#   PYTHON_VERSION: "3.12"
#   APP_DIR: "enterprise-devsecops-hackathon"
#   REPORTS_DIR: "reports"
#   MIN_SEVERITY: "high"
#   OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
#   LLM_ENABLED: "true"
#   LLM_EXPLAIN: "0"
#   LLM_MODE: "openai"

# jobs:

#   # ============================================================
#   # BUILD
#   # ============================================================
#   build-java:
#     runs-on: ubuntu-latest
#     steps:
#       - uses: actions/checkout@v4

#       - uses: actions/setup-java@v4
#         with:
#           distribution: temurin
#           java-version: ${{ env.JAVA_VERSION }}
#           cache: maven

#       - run: mvn -B clean package -DskipTests -f $APP_DIR/app/pom.xml

#       - uses: actions/upload-artifact@v4
#         with:
#           name: app-jar
#           path: ${{ env.APP_DIR }}/app/target/enterprise-app-1.0.jar
#           retention-days: 7

#   # ============================================================
#   # SAST
#   # ============================================================
#   sast:
#     runs-on: ubuntu-latest
#     continue-on-error: true
#     steps:
#       - uses: actions/checkout@v4
#       - uses: actions/setup-java@v4
#         with:
#           distribution: temurin
#           java-version: ${{ env.JAVA_VERSION }}
#       - uses: actions/setup-python@v5
#         with:
#           python-version: ${{ env.PYTHON_VERSION }}

#       - run: mkdir -p $REPORTS_DIR

#       - run: mvn -B clean package -DskipTests -f $APP_DIR/app/pom.xml

#       - run: |
#           pip install semgrep
#           semgrep scan \
#             --config=p/java \
#             --config=p/owasp-top-ten \
#             --json \
#             --output $REPORTS_DIR/semgrep.json \
#             $APP_DIR/app/src/main/java || echo '{}' > $REPORTS_DIR/semgrep.json

#       - name: Run SpotBugs
#         run: |
#           mvn -B verify spotbugs:spotbugs -f $APP_DIR/app/pom.xml || true
      
#       - name: Collect SpotBugs XML
#         run: |
#           if [ -f "$APP_DIR/app/target/spotbugsXml.xml" ]; then
#             cp "$APP_DIR/app/target/spotbugsXml.xml" reports/spotbugs.xml
#           else
#             echo "<BugCollection/>" > reports/spotbugs.xml
#           fi
      
#       - name: Convert SpotBugs XML â†’ JSON
#         run: |
#           pip install xmltodict
#           cat <<'EOF' > convert_spotbugs.py
#           import xmltodict, json, pathlib
#           p = pathlib.Path("reports/spotbugs.xml")
#           if p.exists():
#               data = xmltodict.parse(p.read_text())
#               pathlib.Path("reports/spotbugs.json").write_text(json.dumps(data, indent=2))
#           else:
#               pathlib.Path("reports/spotbugs.json").write_text("{}")
#           EOF
#           python convert_spotbugs.py

#       - uses: actions/upload-artifact@v4
#         with:
#           name: sast-reports
#           path: reports/*.json
#           if-no-files-found: ignore

#   # # ============================================================
#   # # SECRETS
#   # # ============================================================
#   # secrets-scan:
#   #   runs-on: ubuntu-latest
#   #   continue-on-error: true
#   #   steps:
#   #     - uses: actions/checkout@v4
#   #     - run: mkdir -p $REPORTS_DIR
#   #     - run: sudo apt-get update && sudo apt-get install -y jq
#   #     - run: |
#   #         VERSION=$(curl -s https://api.github.com/repos/gitleaks/gitleaks/releases/latest | jq -r .tag_name)
#   #         curl -L -o gitleaks.tar.gz https://github.com/gitleaks/gitleaks/releases/download/${VERSION}/gitleaks_${VERSION#v}_linux_x64.tar.gz
#   #         tar -xzf gitleaks.tar.gz && sudo mv gitleaks /usr/local/bin/
#   #     - run: |
#   #         gitleaks detect --source . --report-format json \
#   #         --report-path $REPORTS_DIR/gitleaks.json || echo '{}' > $REPORTS_DIR/gitleaks.json
#   #     - uses: actions/upload-artifact@v4
#   #       with:
#   #         name: secrets-reports
#   #         path: reports/*.json
#   #         if-no-files-found: ignore

#   # # ============================================================
#   # # SCA
#   # # ============================================================
#   # sca:
#   #   runs-on: ubuntu-latest
#   #   continue-on-error: true
#   #   steps:
#   #     - uses: actions/checkout@v4
#   #     - run: |
#   #         curl -sfL https://raw.githubusercontent.com/aquasecurity/trivy/main/contrib/install.sh | sh
#   #         ./bin/trivy fs --format json --output $REPORTS_DIR/trivy_fs.json \
#   #         $APP_DIR || echo '{}' > $REPORTS_DIR/trivy_fs.json
#   #     - uses: actions/upload-artifact@v4
#   #       with:
#   #         name: sca-reports
#   #         path: reports/*.json

#   # # ============================================================
#   # # IAC
#   # # ============================================================
#   # IAC-scan:
#   #   runs-on: ubuntu-latest
#   #   continue-on-error: true
#   #   steps:
#   #     - uses: actions/checkout@v4
#   #     - run: mkdir -p $REPORTS_DIR
#   #     - run: |
#   #         curl -L https://github.com/aquasecurity/tfsec/releases/latest/download/tfsec-linux-amd64 -o tfsec
#   #         chmod +x tfsec && sudo mv tfsec /usr/local/bin/
#   #     - run: |
#   #         tfsec $APP_DIR/terraform --format json > "$REPORTS_DIR/tfsec.json" || true
#   #     - uses: actions/upload-artifact@v4
#   #       with:
#   #         name: iac-reports
#   #         path: reports/*.json

#   # # ============================================================
#   # # CONTAINER
#   # # ============================================================
#   # container-scan:
#   #   runs-on: ubuntu-latest
#   #   needs: build-java
#   #   continue-on-error: true
#   #   steps:
#   #     - uses: actions/checkout@v4
#   #     - uses: actions/download-artifact@v4
#   #       with:
#   #         name: app-jar
#   #         path: ${{ env.APP_DIR }}/app/target
#   #     - name: Verify jar
#   #       run: |
#   #         echo "Listing target folder:"
#   #         ls -la $APP_DIR/app/target
#   #         if [ ! -f "$APP_DIR/app/target/enterprise-app-1.0.jar" ]; then
#   #           echo "âŒ JAR missing"
#   #           exit 1
#   #         fi
#   #     - run: mkdir -p $REPORTS_DIR
#   #     - name: Build Docker image
#   #       run: |
#   #         docker build \
#   #           -t enterprise-app \
#   #           -f $APP_DIR/docker/Dockerfile \
#   #           .
#   #     - name: Install Trivy
#   #       run: |
#   #         curl -sfL https://raw.githubusercontent.com/aquasecurity/trivy/main/contrib/install.sh | sh
#   #     - name: Trivy Image Scan
#   #       run: |
#   #         ./bin/trivy image enterprise-app \
#   #           --format json \
#   #           --output $REPORTS_DIR/trivy_image.json \
#   #           || echo '{}' > $REPORTS_DIR/trivy_image.json
#   #     - uses: actions/upload-artifact@v4
#   #       with:
#   #         name: container-reports
#   #         path: reports/*.json
#   #         if-no-files-found: ignore

#   # ============================================================
#   # DAST
#   # ============================================================
#   # dast:
#   #   runs-on: ubuntu-latest
#   #   needs: build-java
#   #   continue-on-error: true
#   #   steps:
#   #     - uses: actions/checkout@v4
#   #     - uses: actions/download-artifact@v4
#   #       with:
#   #         name: app-jar
#   #         path: ${{ env.APP_DIR }}/app/target
#   #     - run: mkdir -p $REPORTS_DIR
#   #     - name: Start Application
#   #       run: |
#   #         mkdir -p config/dummy
#   #         java -jar $APP_DIR/app/target/enterprise-app-1.0.jar \
#   #           --spring.config.import=optional:file:./config/*/ &
#   #         sleep 40
#   #     - name: OWASP ZAP Baseline
#   #       run: |
#   #         mkdir -p zap-output
#   #         docker run --rm \
#   #           -u root \
#   #           --network=host \
#   #           -v $(pwd)/zap-output:/zap/wrk:rw \
#   #           ghcr.io/zaproxy/zaproxy:stable \
#   #           zap-baseline.py \
#   #           -t http://localhost:8080 \
#   #           -J zap.json || true
#   #         if [ -f zap-output/zap.json ]; then
#   #           mv zap-output/zap.json $REPORTS_DIR/zap.json
#   #         else
#   #           echo '{}' > $REPORTS_DIR/zap.json
#   #         fi
#   #     - uses: actions/upload-artifact@v4  
#   #       with:
#   #         name: dast-reports
#   #         path: reports/*.json
#   #         if-no-files-found: ignore

#   # ============================================================
#   # AGGREGATE
#   # ============================================================
#   aggregate-reports:
#     runs-on: ubuntu-latest
#     needs: [sast]  
#     if: always()
#     steps:
#       - uses: actions/download-artifact@v4
#         with:
#           path: collected-reports
#       - run: |
#           mkdir -p final-reports
#           find collected-reports -name "*.json" -exec cp {} final-reports/ \; || true
#       - uses: actions/upload-artifact@v4
#         with:
#           name: all-scan-reports
#           path: final-reports/*.json

#   # ============================================================
#   # AI ANALYSIS (pre-gate generation of decision.json)
#   # ============================================================
#   llm-agent-analysis:
#     runs-on: ubuntu-latest
#     needs: aggregate-reports
#     continue-on-error: true
#     env:
#       OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
#     steps:
#       - uses: actions/checkout@v4
#       - uses: actions/setup-python@v5
#         with:
#           python-version: ${{ env.PYTHON_VERSION }}
#       - run: pip install -r requirements.txt
#       - uses: actions/download-artifact@v4
#         with:
#           name: all-scan-reports
#           path: tmp-reports/
#       - run: |
#           mkdir -p reports
#           find tmp-reports -name "*.json" -exec cp {} reports/ \;
#       - run: mkdir -p agent_output
#       - run: |
#           python main.py --reports-dir reports --output-dir agent_output --mode=gate --skip-llm
#       - uses: actions/upload-artifact@v4
#         with:
#           name: ai-results
#           path: agent_output/
  
#   # ============================================================
#   # SECURITY GATE (exposes gate_failed output)
#   # ============================================================
#   security-gate:
#     runs-on: ubuntu-latest
#     needs: llm-agent-analysis
#     outputs:                     # ðŸ”§ expose the flag for downstream jobs
#       gate_failed: ${{ steps.read.outputs.gate_failed }}
#     steps:
#       - uses: actions/download-artifact@v4
#         with:
#           name: ai-results
#           path: agent_output
#       - run: sudo apt-get update && sudo apt-get install -y jq
#       - id: read                 # ðŸ”§ give step an id and write to GITHUB_OUTPUT
#         name: Read gate decision
#         run: |
#           STATUS=$(jq -r '.decision' agent_output/decision.json)
#           echo "Gate decision = $STATUS"
#           if [ "$STATUS" = "FAIL" ]; then
#             echo "gate_failed=true" >> $GITHUB_OUTPUT
#           else
#             echo "gate_failed=false" >> $GITHUB_OUTPUT
#           fi

#   # ============================================================
#   # ANALYSIS & REMEDIATION SUGGESTIONS (LLM)
#   # ============================================================
#   remediation:
#     runs-on: ubuntu-latest
#     needs: security-gate
#     if: always()
#     env:
#       OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
#     steps:
#       - uses: actions/checkout@v4
#       - uses: actions/setup-python@v5
#         with:
#           python-version: ${{ env.PYTHON_VERSION }}
#       - run: pip install -r requirements.txt
  
#       - uses: actions/download-artifact@v4
#         with:
#           name: all-scan-reports
#           path: reports
  
#       - uses: actions/download-artifact@v4
#         with:
#           name: ai-results
#           path: agent_output
  
#       - name: Generate analysis & remediation suggestions
#         run: |
#           python main.py --reports-dir reports --output-dir agent_output --mode=advise
  
#       - uses: actions/upload-artifact@v4
#         with:
#           name: remediation-output-${{github.run_id}}
#           path: agent_output/
#           overwrite: true

#       # ðŸ”§ Enable LLM so it generates analysis + remediation suggestions
#       - name: Generate analysis & remediation suggestions
#         run: |
#           python main.py --reports-dir reports --output-dir agent_output --mode=advise
#         # ^ no --skip-llm here

#       - uses: actions/upload-artifact@v4
#         with:
#           name: remediation-output
#           path: agent_output/

#   # ============================================================
#   # AUTOFIX & PR (only when gate failed)
#   # ============================================================
#   autofix-pr:
#     runs-on: ubuntu-latest
#     needs: remediation
#     if: needs.security-gate.outputs.gate_failed == 'true'
#     permissions:
#       contents: write
#       pull-requests: write
#     steps:
#       - uses: actions/checkout@v4
  
#       - uses: actions/setup-python@v5
#         with:
#           python-version: ${{ env.PYTHON_VERSION }}
  
#       - run: pip install -r requirements.txt
  
#       - uses: actions/download-artifact@v4
#         with:
#           name: all-scan-reports
#           path: reports
  
#       - uses: actions/download-artifact@v4
#         with:
#           name: ai-results
#           path: agent_output
  
#       - name: Run AutoFix + PR
#         env:
#           GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
#         run: |
#           python main.py --reports-dir reports --output-dir agent_output --mode=fix --skip-llm
  
#       - uses: actions/upload-artifact@v4
#         with:
#           name: autofix-output
#           path: agent_output/