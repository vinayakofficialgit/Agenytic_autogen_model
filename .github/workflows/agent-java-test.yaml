name: DevSecOps Agentic AI Pipeline (Enterprise Parallel Java)

on:
  push:
    branches: [test-home-sachin]
#   pull_request:
#     branches: [test-home-sachin]
  workflow_dispatch:

env:
  JAVA_VERSION: "17"
  PYTHON_VERSION: "3.12"
  APP_DIR: "Java-app-main"
  REPORTS_DIR: "reports"
  OUTPUT_DIR: "agent_output"
  OLLAMA_MODEL: "qwen2.5-coder:1.5b"

# ============================================================
# 1️⃣ BUILD STAGE
# ============================================================

jobs:

  build-java:
    runs-on: ubuntu-latest
    outputs:
      artifact-name: java-build-artifact

    steps:
      - uses: actions/checkout@v4

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: ${{ env.JAVA_VERSION }}
          cache: maven

      - name: Build Application
        working-directory: ${{ env.APP_DIR }}
        run: mvn -B clean package -DskipTests

      - name: Upload Build Artifact
        uses: actions/upload-artifact@v4
        with:
          name: java-build
          path: ${{ env.APP_DIR }}/target

# ============================================================
# 2️⃣ STATIC SECURITY (Parallel)
# ============================================================

  security-static:
    runs-on: ubuntu-latest
    needs: build-java

    steps:
      - uses: actions/checkout@v4
      - run: mkdir -p $REPORTS_DIR

      - uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: ${{ env.JAVA_VERSION }}
          cache: maven

      - name: SpotBugs
        working-directory: ${{ env.APP_DIR }}
        run: mvn com.github.spotbugs:spotbugs-maven-plugin:spotbugs -Dspotbugs.failOnError=false

      - name: Checkstyle
        working-directory: ${{ env.APP_DIR }}
        run: mvn checkstyle:check -Dcheckstyle.failOnViolation=false

      - uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install Semgrep
        run: pip install semgrep

      - name: Run Semgrep
        run: |
          semgrep scan \
            --config=auto \
            --json \
            --output $REPORTS_DIR/semgrep.json \
            $APP_DIR

      - uses: actions/upload-artifact@v4
        with:
          name: static-reports
          path: ${{ env.REPORTS_DIR }}

# ============================================================
# 3️⃣ DEPENDENCY SECURITY (Parallel)
# ============================================================

  security-dependency:
    runs-on: ubuntu-latest
    needs: build-java

    steps:
      - uses: actions/checkout@v4
      - run: mkdir -p $REPORTS_DIR

      - uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: ${{ env.JAVA_VERSION }}
          cache: maven

      - name: Generate SBOM
        working-directory: ${{ env.APP_DIR }}
        run: mvn org.cyclonedx:cyclonedx-maven-plugin:makeAggregateBom

      - name: Cache OWASP Dependency DB
        uses: actions/cache@v4
        with:
          path: ~/.dependency-check-data
          key: owasp-db-${{ runner.os }}

    #   - name: OWASP Dependency Check
    #     uses: dependency-check/Dependency-Check_Action@main
    #     with:
    #       project: EnterpriseJavaApp
    #       path: ${{ env.APP_DIR }}
    #       format: JSON
    #       out: ${{ env.REPORTS_DIR }}
    #       args: --failOnCVSS 9

      - name: Download OWASP Dependency Check
        run: |
          VERSION=9.0.9
          curl -L -o dc.zip https://github.com/jeremylong/DependencyCheck/releases/download/v${VERSION}/dependency-check-9.0.9-release.zip
          unzip -o dc.zip
          mv dependency-check /opt/dependency-check

      - name: Run OWASP Dependency Check
        run: |
          /opt/dependency-check/bin/dependency-check.sh \
            --project EnterpriseJavaApp \
            --scan $APP_DIR \
            --format JSON \
            --out $REPORTS_DIR \
            --data ~/.dependency-check-data \
            --failOnCVSS 9 \
            --nvdApiKey=${{secrets.NVD_API_KEY}}

      - uses: actions/upload-artifact@v4
        with:
          name: dependency-reports
          path: ${{ env.REPORTS_DIR }}

# # ============================================================
# # 4️⃣ CONTAINER SECURITY (Parallel)
# # ============================================================

#   security-container:
#     runs-on: ubuntu-latest
#     needs: build-java

#     steps:
#       - uses: actions/checkout@v4
#       - run: mkdir -p $REPORTS_DIR

#       - name: Lint Dockerfile
#         uses: hadolint/hadolint-action@v3
#         with:
#           dockerfile: ${{ env.APP_DIR }}/Dockerfile

#       - name: Build Image
#         run: docker build -t enterprise-java-app:scan $APP_DIR

#       - name: Trivy Scan
#         uses: aquasecurity/trivy-action@0.20.0
#         with:
#           image-ref: enterprise-java-app:scan
#           format: json
#           output: ${{ env.REPORTS_DIR }}/trivy_image.json
#           severity: CRITICAL,HIGH

#       - uses: actions/upload-artifact@v4
#         with:
#           name: container-reports
#           path: ${{ env.REPORTS_DIR }}

# # ============================================================
# # 5️⃣ INFRA SECURITY (Parallel)
# # ============================================================

#   security-infra:
#     runs-on: ubuntu-latest
#     needs: build-java

#     steps:
#       - uses: actions/checkout@v4
#       - run: mkdir -p $REPORTS_DIR

#       - name: Install kube-linter
#         run: |
#           curl -sSL https://github.com/stackrox/kube-linter/releases/latest/download/kube-linter-linux.tar.gz | tar -xz
#           sudo mv kube-linter /usr/local/bin/

#       - name: Run kube-linter
#         run: |
#           kube-linter lint k8s/ \
#             --format json > $REPORTS_DIR/kube_linter.json || true

#       - uses: actions/upload-artifact@v4
#         with:
#           name: infra-reports
#           path: ${{ env.REPORTS_DIR }}

# # ============================================================
# # 6️⃣ DAST (Parallel)
# # ============================================================

#   security-dast:
#     runs-on: ubuntu-latest
#     needs: build-java

#     steps:
#       - uses: actions/checkout@v4
#       - run: mkdir -p $REPORTS_DIR

#       - name: Build Docker Image
#         run: docker build -t enterprise-java-app:scan $APP_DIR

#       - name: Run App Container
#         run: |
#           docker run -d -p 8080:8080 --name app-test enterprise-java-app:scan
#           sleep 20

#       - name: Run OWASP ZAP
#         uses: zaproxy/action-baseline@v0.10.0
#         with:
#           target: http://localhost:8080
#           format: json
#           output: ${{ env.REPORTS_DIR }}/zap.json

#       - uses: actions/upload-artifact@v4
#         with:
#           name: dast-reports
#           path: ${{ env.REPORTS_DIR }}
