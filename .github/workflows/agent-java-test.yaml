name: DevSecOps Agentic AI Pipeline (Enterprise Java Parallel - Stable)

on:
  push:
    branches: [test-home-sachin]
  pull_request:
    branches: [test-home-sachin]
  workflow_dispatch:

env:
  JAVA_VERSION: "17"
  PYTHON_VERSION: "3.12"
  # APP_DIR: "Java-app-main"
  APP_DIR: "enterprise-devsecops-hackathon"
  REPORTS_DIR: "reports"
  OUTPUT_DIR: "agent_output"
  OLLAMA_MODEL: "qwen2.5-coder:1.5b"
  MIN_SEVERITY: "critical"

# ============================================================
# JOB 1 – BUILD JAVA (BASE ARTIFACT)
# ============================================================

jobs:
  build-java:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: ${{ env.JAVA_VERSION }}
          cache: maven

      - name: Build Java
        run: |
          cd $APP_DIR/app || exit 0
          mvn -B clean package -DskipTests || true

      - uses: actions/upload-artifact@v4
        with:
          name: java-build
          path: ${{ env.APP_DIR }}
          if-no-files-found: ignore

# ============================================================
# JOB 2 – SAST
# ============================================================

  sast-scan:
    runs-on: ubuntu-latest
    needs: build-java
    continue-on-error: true

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: pip

      - uses: actions/download-artifact@v4
        with:
          name: java-build
          path: ${{ env.APP_DIR }}
        continue-on-error: true

      - run: mkdir -p $REPORTS_DIR

      - name: Run Semgrep
        run: |
          pip install semgrep || true
          semgrep scan \
            --config=p/java \
            --config=p/owasp-top-ten \
            --json \
            --output $REPORTS_DIR/semgrep.json \
            $APP_DIR || echo '{}' > $REPORTS_DIR/semgrep.json

      - name: SpotBugs
        run: |
          mkdir -p $REPORTS_DIR
      
          mvn com.github.spotbugs:spotbugs-maven-plugin:4.9.8.2:spotbugs \
            -Dspotbugs.outputFormat=json \
            -f $APP_DIR/app/pom.xml || true
      
          if [ -f $APP_DIR/app/target/spotbugsJson.json ]; then
            cp $APP_DIR/app/target/spotbugsJson.json $REPORTS_DIR/spotbugs.json
          else
            echo '{}' > $REPORTS_DIR/spotbugs.json
          fi
      
      - uses: actions/upload-artifact@v4
        with:
          name: sast-reports
          path: reports/*.json
          if-no-files-found: ignore