name: DevSecOps Agentic AI Pipeline

on:
  push:
    branches: [feature/AgentAI]
  pull_request:
  workflow_dispatch:

permissions:
  contents: read

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  PYTHON_VERSION: "3.12"
  APP_DIR: "Order-app-main"
  REPORTS_DIR: "reports"
  OUTPUT_DIR: "agent_output"
  ACTIONS_STEP_DEBUG: "true"

  # LLM params (overridable via repo Variables or Secrets)
  LLM_ENABLED: ${{ vars.LLM_ENABLED || '1' }}
  LLM_AUTOFIX: ${{ vars.LLM_AUTOFIX || '1' }}
  OLLAMA_MODEL: ${{ vars.OLLAMA_MODEL || secrets.OLLAMA_MODEL || 'qwen2.5-coder:3b' }}
  OLLAMA_NUM_CTX: ${{ vars.OLLAMA_NUM_CTX || '2048' }}
  OLLAMA_NUM_PREDICT: ${{ vars.OLLAMA_NUM_PREDICT || '512' }}
  OLLAMA_TEMPERATURE: ${{ vars.OLLAMA_TEMPERATURE || '0.1' }}
  MIN_SEVERITY: ${{ vars.MIN_SEVERITY || 'high' }}
  LLM_AUTOFIX_TOOLS: ${{ vars.LLM_AUTOFIX_TOOLS || 'trivy_fs,semgrep,conftest,gitleaks' }}
  NO_PROXY: "127.0.0.1,localhost"

jobs:
  # ============================================================
  # JOB 1: SECURITY SCANS
  # ============================================================
  security-scan:
    name: "ğŸ” Security Scan"
    runs-on: ubuntu-22.04
    timeout-minutes: 45

    steps:
      - uses: actions/checkout@v4
      - name: Prepare directories
        run: |
          set -Eeuo pipefail
          mkdir -p "$REPORTS_DIR"

      # -------- SEMGREP (official action) --------
      - name: Semgrep (official action)
        uses: returntocorp/semgrep-action@v1
        with:
          generateSarif: false
          config: auto
          json: ${{ env.REPORTS_DIR }}/semgrep.json
          enable_metrics: false
        continue-on-error: true

      # -------- TRIVY FS (pin release) --------
      - name: Install Trivy
        run: |
          set -Eeuo pipefail
          curl -sfL https://raw.githubusercontent.com/aquasecurity/trivy/main/contrib/install.sh \
            | sh -s -- -b /usr/local/bin v0.54.1
          trivy --version

      - name: Run Trivy FS
        continue-on-error: true
        run: |
          set -Eeuo pipefail
          trivy fs --format json --output "$REPORTS_DIR/trivy_fs.json" "$APP_DIR" || true
          test -f "$REPORTS_DIR/trivy_fs.json" || echo '{}' > "$REPORTS_DIR/trivy_fs.json"

      # -------- TRIVY IMAGE (optional) --------
      - name: Run Trivy Image (if Dockerfile exists)
        continue-on-error: true
        run: |
          set -Eeuo pipefail
          if [ -f "$APP_DIR/Dockerfile" ]; then
            docker build -t order-app:scan "$APP_DIR"
            trivy image --format json --output "$REPORTS_DIR/trivy_image.json" order-app:scan || true
          else
            echo '{}' > "$REPORTS_DIR/trivy_image.json"
          fi
          test -f "$REPORTS_DIR/trivy_image.json"

      # -------- GITLEAKS --------
      - name: Install Gitleaks
        run: |
          set -Eeuo pipefail
          sudo apt-get update
          sudo apt-get install -y jq
          VERSION=$(curl -s https://api.github.com/repos/gitleaks/gitleaks/releases/latest | jq -r .tag_name)
          curl -sL "https://github.com/gitleaks/gitleaks/releases/download/${VERSION}/gitleaks_${VERSION#v}_linux_x64.tar.gz" \
            | tar -xz
          sudo mv gitleaks /usr/local/bin/

      - name: Run Gitleaks
        continue-on-error: true
        run: |
          set -Eeuo pipefail
          gitleaks detect --source . --report-format json --report-path "$REPORTS_DIR/gitleaks.json" --no-git || true
          test -f "$REPORTS_DIR/gitleaks.json" || echo '[]' > "$REPORTS_DIR/gitleaks.json"

      # -------- CONFTEST --------
      - name: Install Conftest
        run: |
          set -Eeuo pipefail
          sudo apt-get update && sudo apt-get install -y jq curl
          VERSION=$(curl -s https://api.github.com/repos/open-policy-agent/conftest/releases/latest | jq -r .tag_name)
          curl -sL "https://github.com/open-policy-agent/conftest/releases/download/${VERSION}/conftest_${VERSION#v}_Linux_x86_64.tar.gz" \
            | tar -xz
          sudo mv conftest /usr/local/bin/
          conftest --version

      - name: Run Conftest (Policies)
        continue-on-error: true
        run: |
          set -Eeuo pipefail
          conftest test k8s terraform policy --output json > "$REPORTS_DIR/conftest.json" || echo "[]" > "$REPORTS_DIR/conftest.json"
          test -f "$REPORTS_DIR/conftest.json"

      - name: Show Job 1 reports (before upload)
        run: |
          set -Eeuo pipefail
          echo "Listing reports/ just before upload:"
          ls -la reports/ || true
          echo ""
          echo "File sizes:"
          du -h reports/* || true    

      - name: Upload scan reports
        uses: actions/upload-artifact@v4
        with:
          name: scan-reports
          path: reports/
          retention-days: 7

  # ============================================================
  # JOB 2+3: AI ANALYSIS + REMEDIATION (MERGED, REUSE OLLAMA)
  # ============================================================
  ai-remediation:
    name: ğŸ¤– AI Analysis + ğŸ’¡ Remediation
    runs-on: ubuntu-22.04
    needs: security-scan

    permissions:
      contents: write
      pull-requests: write

    outputs:
      pipeline_status: ${{ steps.capture_status.outputs.pipeline_status }}
      suggestions_created: ${{ steps.generate.outputs.suggestions_created }}
      total_findings: ${{ steps.metrics.outputs.total_findings }}
      critical_count: ${{ steps.metrics.outputs.critical }}
      high_count: ${{ steps.metrics.outputs.high }}
      medium_count: ${{ steps.metrics.outputs.medium }}
      reason: ${{ steps.metrics.outputs.reason }}

    env:
      OLLAMA_URL: "http://localhost:11434"

    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install dependencies (jq + Python libs)
        run: |
          set -Eeuo pipefail
          sudo apt-get update
          sudo apt-get install -y jq curl
          pip install pyyaml requests

      - name: Download scan artifacts
        uses: actions/download-artifact@v4
        with:
          name: scan-reports
          path: reports/

      - name: Verify downloaded reports (start of Job 2)
        run: |
          set -Eeuo pipefail
          echo "Listing reports/ right after artifact download:"
          ls -la reports/ || true
          echo ""
          for f in reports/*.json; do
            [ -f "$f" ] || continue
            echo "---- $f (head -c 300) ----"
            head -c 300 "$f" || true
            echo -e "\n"
          done    

      # ------ OLLAMA: start once & pull model ------
      - name: Validate OLLAMA_MODEL
        run: |
          set -Eeuo pipefail
          if [ -z "${{ env.OLLAMA_MODEL }}" ]; then
            echo "OLLAMA_MODEL is not set"; exit 1
          fi
          echo "Using OLLAMA_MODEL=${{ env.OLLAMA_MODEL }}"

      - name: Install & start Ollama
        run: |
          set -Eeuo pipefail
          curl -fsSL https://ollama.com/install.sh | sh
          nohup ollama serve > /tmp/ollama.log 2>&1 &
          for i in $(seq 1 30); do
            curl -sf http://localhost:11434/api/tags > /dev/null 2>&1 && break
            sleep 2
          done
          ollama pull "${{ env.OLLAMA_MODEL }}"

      # ------ PHASE 1: AI analysis ------
      - name: Run agentic analysis
        run: |
          set -Eeuo pipefail
          python main.py --verbose || true

      - name: Compute scan metrics (counts & reason)
        id: metrics
        run: |
          set -Eeuo pipefail
          jq_bin=jq

          semgrep_total=$($jq_bin '.results | length' reports/semgrep.json 2>/dev/null || echo 0)
          trivyfs_total=$($jq_bin '[.Results[]? | (.Vulnerabilities // []) + (.Misconfigurations // [])] | length' reports/trivy_fs.json 2>/dev/null || echo 0)
          trivyimg_total=$($jq_bin '[.Results[]? | (.Vulnerabilities // [])] | length' reports/trivy_image.json 2>/dev/null || echo 0)
          tfsec_total=$($jq_bin '.results | length' reports/tfsec.json 2>/dev/null || echo 0)
          gitleaks_total=$($jq_bin 'length' reports/gitleaks.json 2>/dev/null || echo 0)
          conftest_total=$($jq_bin '[.[].failures[]?] | length' reports/conftest.json 2>/dev/null || echo 0)

          # Severity from Trivy FS + Image
          trivyfs_high=$($jq_bin '[.Results[]? | (.Vulnerabilities // []) + (.Misconfigurations // []) | .[] | select((.Severity // .severity)=="HIGH")] | length' reports/trivy_fs.json 2>/dev/null || echo 0)
          trivyfs_critical=$($jq_bin '[.Results[]? | (.Vulnerabilities // []) + (.Misconfigurations // []) | .[] | select((.Severity // .severity)=="CRITICAL")] | length' reports/trivy_fs.json 2>/dev/null || echo 0)
          trivyfs_medium=$($jq_bin '[.Results[]? | (.Vulnerabilities // []) + (.Misconfigurations // []) | .[] | select((.Severity // .severity)=="MEDIUM")] | length' reports/trivy_fs.json 2>/dev/null || echo 0)

          trivyimg_high=$($jq_bin '[.Results[]? | (.Vulnerabilities // []) | .[] | select(.Severity=="HIGH")] | length' reports/trivy_image.json 2>/dev/null || echo 0)
          trivyimg_critical=$($jq_bin '[.Results[]? | (.Vulnerabilities // []) | .[] | select(.Severity=="CRITICAL")] | length' reports/trivy_image.json 2>/dev/null || echo 0)
          trivyimg_medium=$($jq_bin '[.Results[]? | (.Vulnerabilities // []) | .[] | select(.Severity=="MEDIUM")] | length' reports/trivy_image.json 2>/dev/null || echo 0)

          total_findings=$((semgrep_total + trivyfs_total + trivyimg_total + tfsec_total + gitleaks_total + conftest_total))
          high=$((trivyfs_high + trivyimg_high))
          critical=$((trivyfs_critical + trivyimg_critical))
          medium=$((trivyfs_medium + trivyimg_medium))

          if [ $((high + critical)) -gt 0 ]; then
            reason="High/Critical findings present"
          else
            reason="No high/critical findings"
          fi

          echo "total_findings=$total_findings" >> "$GITHUB_OUTPUT"
          echo "high=$high" >> "$GITHUB_OUTPUT"
          echo "critical=$critical" >> "$GITHUB_OUTPUT"
          echo "medium=$medium" >> "$GITHUB_OUTPUT"
          echo "reason=$reason" >> "$GITHUB_OUTPUT"

      - name: Capture decision output (fallback to metrics)
        id: capture_status
        run: |
          set -Eeuo pipefail
          STATUS="fail"
          if [ -f "$OUTPUT_DIR/decision.json" ]; then
            STATUS=$(jq -r '.status // empty' "$OUTPUT_DIR/decision.json" || echo "")
          fi
          if [ -z "$STATUS" ] || [ "$STATUS" = "null" ]; then
            # derive from metrics if decision missing
            if [ $(( ${{ steps.metrics.outputs.critical }} + ${{ steps.metrics.outputs.high }} )) -gt 0 ]; then
              STATUS="fail"
            else
              STATUS="pass"
            fi
          fi
          echo "pipeline_status=$STATUS" >> "$GITHUB_OUTPUT"
          echo "Final pipeline_status=$STATUS"

      - name: Upload AI analysis results
        uses: actions/upload-artifact@v4
        with:
          name: ai-results
          path: agent_output/

      # ------ PHASE 2: Remediation (only when failing on push) ------
      - name: Generate remediation suggestions
        if: |
          github.event_name == 'push' &&
          steps.capture_status.outputs.pipeline_status == 'fail'
        id: generate
        env:
          OLLAMA_URL: "http://localhost:11434"
          OLLAMA_MODEL: ${{ env.OLLAMA_MODEL }}
          OLLAMA_NUM_PREDICT: ${{ env.OLLAMA_NUM_PREDICT }}
        run: |
          set -Eeuo pipefail
          mkdir -p remediation-suggestions

          python3 << 'PYEOF'
          import json, os, requests
          from pathlib import Path
          from datetime import datetime
          REPORTS=Path("reports"); SUG=Path("remediation-suggestions")
          OURL=os.getenv("OLLAMA_URL","http://localhost:11434")
          OMOD=os.getenv("OLLAMA_MODEL","qwen2.5-coder:3b")
          NP=int(os.getenv("OLLAMA_NUM_PREDICT","512"))

          def ask(sys, usr):
              try:
                  r=requests.post(f"{OURL}/api/chat", json={
                      "model": OMOD,
                      "messages":[{"role":"system","content":sys},{"role":"user","content":usr}],
                      "stream": False,
                      "options":{"temperature":0.1,"num_predict":NP}
                  }, timeout=120)
                  r.raise_for_status()
                  return r.json().get("message",{}).get("content","")
              except Exception as e:
                  print("[LLM Error]", e); return ""

          def jload(p:Path):
              try: return json.loads(p.read_text())
              except Exception: return {}

          SUG.mkdir(parents=True, exist_ok=True)
          total=0
          sg=jload(REPORTS/"semgrep.json"); total += len(sg.get("results",[])) if isinstance(sg,dict) else 0
          tf=jload(REPORTS/"trivy_fs.json")
          if isinstance(tf,dict):
              for r in tf.get("Results",[]) or []:
                  total += len((r.get("Vulnerabilities") or [])) + len((r.get("Misconfigurations") or []))
          gl=jload(REPORTS/"gitleaks.json"); total += len(gl) if isinstance(gl,list) else 0
          ct=jload(REPORTS/"conftest.json")
          if isinstance(ct,list):
              for e in ct:
                  total += len(e.get("failures",[]) if isinstance(e,dict) else [])

          (SUG/"README.md").write_text(
              "# ğŸ’¡ Remediation Suggestions\n\n"
              f"Generated: {datetime.utcnow().isoformat()}Z\n\n"
              "This folder contains AI-generated guidance to fix findings from scans.\n"
              "Review carefully before applying.\n"
          )
          (SUG/"summary.json").write_text(json.dumps({
              "generatedAt": datetime.utcnow().isoformat()+"Z",
              "totalFindings": total
          }, indent=2))

          with open(os.environ["GITHUB_OUTPUT"],"a") as f:
              f.write(f"suggestions_created={'true' if total>0 else 'false'}\n")
          PYEOF

      - name: Show generated suggestions
        if: |
          github.event_name == 'push' &&
          steps.capture_status.outputs.pipeline_status == 'fail'
        run: |
          set -Eeuo pipefail
          echo "=== remediation-suggestions ==="
          ls -la remediation-suggestions || true
          [ -f remediation-suggestions/summary.json ] && cat remediation-suggestions/summary.json || true

      - name: Upload remediation artifacts
        if: |
          github.event_name == 'push' &&
          steps.capture_status.outputs.pipeline_status == 'fail'
        uses: actions/upload-artifact@v4
        with:
          name: remediation-suggestions
          path: remediation-suggestions/

      # Optional: auto-PR with suggestions (only if created)
      - name: Generate unique branch name
        if: |
          github.event_name == 'push' &&
          steps.capture_status.outputs.pipeline_status == 'fail' &&
          steps.generate.outputs.suggestions_created == 'true'
        id: branch
        run: |
          set -Eeuo pipefail
          echo "name=remediation/suggestions-run-${{ github.run_number }}" >> "$GITHUB_OUTPUT"

      - name: Create suggestions PR
        if: |
          github.event_name == 'push' &&
          steps.capture_status.outputs.pipeline_status == 'fail' &&
          steps.generate.outputs.suggestions_created == 'true'
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          branch: ${{ steps.branch.outputs.name }}
          delete-branch: true
          add-paths: remediation-suggestions/**
          title: "ğŸ’¡ Security Remediation Suggestions (Run #${{ github.run_number }})"
          commit-message: "docs: add LLM-generated remediation suggestions"
          body: |
            ## ğŸ’¡ AI-Generated Remediation Suggestions
            **Run:** #${{ github.run_number }}

            This PR contains **suggestion files only** â€” no source code was modified.

            | Folder | Contents |
            |--------|----------|
            | `remediation-suggestions/` | Per-tool fix suggestions you can copy-paste |

            > âš ï¸ **These are AI-generated suggestions. Always review before applying.**

  # ============================================================
  # JOB 4: GATE (final verdict)
  # ============================================================
  gate-check:
    name: ğŸš¦ Security Gate
    runs-on: ubuntu-22.04
    needs: [ai-remediation]
    if: always()

    steps:
      - name: Ensure jq is available
        run: |
          sudo apt-get update
          sudo apt-get install -y jq

      - name: Download AI results
        uses: actions/download-artifact@v4
        with:
          name: ai-results
          path: agent_output/

      - name: Evaluate gate
        run: |
          set -Eeuo pipefail
          if [ -f agent_output/decision.json ]; then
            STATUS=$(jq -r '.status' agent_output/decision.json)
          else
            # Fallback to workflow output
            STATUS="${{ needs.ai-remediation.outputs.pipeline_status }}"
          fi
          echo "Final status: $STATUS"
          if [ "$STATUS" = "fail" ]; then
            echo "âŒ Security gate FAILED â€” review remediation suggestions/PR"
            exit 1
          fi
          echo "âœ… Security gate PASSED"

  # ============================================================
  # JOB 5: Gmail Email Notification
  # ============================================================
  email-notification:
    name: ğŸ“§ Gmail Notification
    runs-on: ubuntu-22.04
    needs: [ai-remediation, gate-check]
    if: always()

    steps:
      - name: ğŸ“§ Prepare & Send Email
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 587
          username: ${{ secrets.GMAIL_USERNAME }}
          password: ${{ secrets.GMAIL_APP_PASSWORD }}
          subject: "${{ needs.ai-remediation.outputs.pipeline_status == 'fail' && 'ğŸ”´ [SECURITY ALERT]' || 'ğŸŸ¢ [SECURITY OK]' }} ${{ github.repository }} - ${{ github.ref_name }}"
          to: ${{ secrets.NOTIFICATION_EMAIL }}
          from: "Agentic DevSecOps Pipeline <${{ secrets.GMAIL_USERNAME }}>"
          body: |
            â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                        DevSecOps Security Scan Report
            â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

            Status:     ${{ needs.ai-remediation.outputs.pipeline_status == 'fail' && 'âŒ FAILED' || 'âœ… PASSED' }}
            Repository: ${{ github.repository }}
            Branch:     ${{ github.ref_name }}
            Commit:     ${{ github.sha }}
            Actor:      ${{ github.actor }}

            â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
                                SCAN RESULTS (Aggregated)
            â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

            Total Findings:  ${{ needs.ai-remediation.outputs.total_findings }}
            ğŸ”´ Critical:     ${{ needs.ai-remediation.outputs.critical_count }}
            ğŸŸ  High:         ${{ needs.ai-remediation.outputs.high_count }}
            ğŸŸ¡ Medium:       ${{ needs.ai-remediation.outputs.medium_count }}
            Reason:          ${{ needs.ai-remediation.outputs.reason }}

            â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
                             REMEDIATION SUGGESTIONS
            â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

            Suggestions Generated: ${{ needs.ai-remediation.outputs.suggestions_created || 'false' }}
            Gate Result:           ${{ needs.gate-check.result }}

            ${{ needs.ai-remediation.outputs.suggestions_created == 'true' && 'ğŸ’¡ A PR with remediation suggestions has been created. Review and apply the fixes.' || '' }}

            â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
                                    LINKS
            â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

            ğŸ“‹ View Run:    https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}
            ğŸ“ View Commit: https://github.com/${{ github.repository }}/commit/${{ github.sha }}

            ${{ needs.ai-remediation.outputs.pipeline_status == 'fail' && 'âš ï¸  ACTION REQUIRED: Please review remediation suggestions and fix security issues before merging.' || 'âœ… All security checks passed.' }}

          priority: ${{ needs.ai-remediation.outputs.pipeline_status == 'fail' && 'high' || 'normal' }}