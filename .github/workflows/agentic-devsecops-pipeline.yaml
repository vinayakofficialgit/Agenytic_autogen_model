



# name: DevSecOps Agentic AI Pipeline

# on:
#   push:
#     branches: [main, test-v-branch]
#   pull_request:
#     branches: [main, test-v-branch]

# env:
#   PYTHON_VERSION: '3.12'
#   REPORTS_DIR: reports
#   OUTPUT_DIR: agent_output
#   MIN_SEVERITY: high
#   LLM_ENABLED: '1'
#   OLLAMA_MODEL: llama3:latest

# # ==========================================================
# # JOB 1: SECURITY SCANNING
# # ==========================================================
# jobs:
#   security-scan:
#     name: ðŸ” Security Scan
#     runs-on: ubuntu-latest

#     steps:
#       - uses: actions/checkout@v4
#         with:
#           fetch-depth: 0

#       - name: Enable Debug
#         run: set -x

#       - name: Prepare directories
#         run: mkdir -p $REPORTS_DIR

#       # ---------------- SEMGREP ----------------
#       - name: Run Semgrep
#         continue-on-error: true
#         run: |
#           pip install semgrep
#           semgrep scan --config=auto --json \
#             --output=$REPORTS_DIR/semgrep.json . \
#             || echo '{"results":[]}' > $REPORTS_DIR/semgrep.json

#       # ---------------- TRIVY ----------------
#       - name: Install Trivy
#         run: |
#           sudo apt-get update
#           sudo apt-get install -y wget gnupg lsb-release
#           wget -qO - https://aquasecurity.github.io/trivy-repo/deb/public.key | sudo apt-key add -
#           echo deb https://aquasecurity.github.io/trivy-repo/deb $(lsb_release -sc) main \
#             | sudo tee /etc/apt/sources.list.d/trivy.list
#           sudo apt-get update
#           sudo apt-get install -y trivy

#       - name: Run Trivy FS + Image
#         continue-on-error: true
#         run: |
#           trivy fs --format json --output $REPORTS_DIR/trivy_fs.json . \
#             || echo '{"Results":[]}' > $REPORTS_DIR/trivy_fs.json

#           if [ -f Dockerfile ]; then
#             docker build -t scan-target .
#             trivy image --format json \
#               --output $REPORTS_DIR/trivy_image.json scan-target \
#               || echo '{"Results":[]}' > $REPORTS_DIR/trivy_image.json
#           fi

#       # ---------------- TFSEC ----------------
#       - name: Run tfsec
#         continue-on-error: true
#         run: |
#           curl -s https://raw.githubusercontent.com/aquasecurity/tfsec/master/scripts/install_linux.sh | bash
#           if [ -d terraform ]; then
#             tfsec terraform --format json > $REPORTS_DIR/tfsec.json \
#               || echo '{"results":[]}' > $REPORTS_DIR/tfsec.json
#           fi

#       # ---------------- GITLEAKS ----------------
#       - name: Run Gitleaks
#         continue-on-error: true
#         run: |
#           wget -qO gitleaks.tar.gz https://github.com/gitleaks/gitleaks/releases/latest/download/gitleaks_linux_x64.tar.gz
#           tar -xzf gitleaks.tar.gz
#           sudo mv gitleaks /usr/local/bin
#           gitleaks detect --source . \
#             --report-format json \
#             --report-path $REPORTS_DIR/gitleaks.json \
#             --no-git || echo '[]' > $REPORTS_DIR/gitleaks.json

#       # ---------------- CONFTEST ----------------
#       - name: Run Conftest
#         continue-on-error: true
#         run: |
#           wget -qO conftest.tar.gz https://github.com/open-policy-agent/conftest/releases/latest/download/conftest_Linux_x86_64.tar.gz
#           tar -xzf conftest.tar.gz
#           sudo mv conftest /usr/local/bin

#           conftest test Dockerfile -o json > $REPORTS_DIR/conftest_docker.json || echo '[]' > $REPORTS_DIR/conftest_docker.json
#           conftest test k8s/ -o json > $REPORTS_DIR/conftest_k8s.json || echo '[]' > $REPORTS_DIR/conftest_k8s.json
#           conftest test terraform/ -o json > $REPORTS_DIR/conftest_tf.json || echo '[]' > $REPORTS_DIR/conftest_tf.json

#       - name: Upload scan reports
#         uses: actions/upload-artifact@v4
#         with:
#           name: scan-reports
#           path: $REPORTS_DIR/

# # ==========================================================
# # JOB 2: AGENTIC AI ANALYSIS
# # ==========================================================
#   ai-analysis:
#     name: ðŸ¤– Agentic AI Analysis
#     runs-on: ubuntu-latest
#     needs: security-scan

#     outputs:
#       pipeline_status: ${{ steps.analyze.outputs.pipeline_status }}

#     steps:
#       - uses: actions/checkout@v4

#       - uses: actions/setup-python@v5
#         with:
#           python-version: ${{ env.PYTHON_VERSION }}

#       - run: pip install requests pyyaml

#       - uses: actions/download-artifact@v4
#         with:
#           name: scan-reports
#           path: $REPORTS_DIR

#       - run: mkdir -p $OUTPUT_DIR

#       - name: Run pipeline (DEBUG)
#         id: analyze
#         run: |
#           set -x
#           python main.py -v

#           STATUS=$(jq -r '.status' $OUTPUT_DIR/decision.json)
#           echo "pipeline_status=$STATUS" >> $GITHUB_OUTPUT

#       - uses: actions/upload-artifact@v4
#         with:
#           name: ai-output
#           path: $OUTPUT_DIR/

# # ==========================================================
# # JOB 3: CREATE REMEDIATION PR (BEST PRACTICE)
# # ==========================================================
#   create-pr:
#     name: ðŸ”§ Create Remediation PR
#     runs-on: ubuntu-latest
#     needs: ai-analysis

#     if: |
#       github.event_name == 'push' &&
#       needs.ai-analysis.outputs.pipeline_status == 'fail'

#     permissions:
#       contents: write
#       pull-requests: write

#     steps:
#       - uses: actions/checkout@v4

#       - name: Create PR
#         run: |
#           set -x
#           gh pr create \
#             --title "security: automated remediation" \
#             --body "Agentic DevSecOps pipeline detected security issues and applied fixes." \
#             --base main \
#             --head ${{ github.ref_name }}
#         env:
#           GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

# # ==========================================================
# # JOB 4: PR COMMENT (READ-ONLY MODE)
# # ==========================================================
#   pr-comment:
#     name: ðŸ’¬ PR Comment
#     runs-on: ubuntu-latest
#     needs: ai-analysis
#     if: github.event_name == 'pull_request'

#     permissions:
#       pull-requests: write

#     steps:
#       - uses: actions/download-artifact@v4
#         with:
#           name: ai-output
#           path: $OUTPUT_DIR

#       - uses: actions/github-script@v7
#         with:
#           script: |
#             const fs = require('fs');
#             const body = fs.readFileSync('agent_output/pr_comment.md','utf8');
#             github.rest.issues.createComment({
#               issue_number: context.issue.number,
#               owner: context.repo.owner,
#               repo: context.repo.repo,
#               body
#             })

# # ==========================================================
# # JOB 5: SECURITY GATE
# # ==========================================================
#   gate:
#     name: ðŸš¦ Security Gate
#     runs-on: ubuntu-latest
#     needs: ai-analysis

#     steps:
#       - uses: actions/download-artifact@v4
#         with:
#           name: ai-output
#           path: $OUTPUT_DIR

#       - run: |
#           STATUS=$(jq -r '.status' $OUTPUT_DIR/decision.json)
#           [ "$STATUS" = "fail" ] && exit 1 || echo "Gate passed"

# # ==========================================================
# # JOB 6: EMAIL NOTIFICATION
# # ==========================================================
#   notify:
#     name: ðŸ“§ Email Notification
#     runs-on: ubuntu-latest
#     needs: [ai-analysis, gate]
#     if: always()

#     steps:
#       - uses: dawidd6/action-send-mail@v3
#         with:
#           server_address: smtp.gmail.com
#           server_port: 587
#           username: ${{ secrets.GMAIL_USERNAME }}
#           password: ${{ secrets.GMAIL_APP_PASSWORD }}
#           subject: "DevSecOps Scan Result"
#           to: ${{ secrets.NOTIFICATION_EMAIL }}
#           from: "DevSecOps Pipeline <${{ secrets.GMAIL_USERNAME }}>"
#           body: "Pipeline completed. Status: ${{ needs.ai-analysis.outputs.pipeline_status }}"













name: DevSecOps Agentic AI Pipeline

on:
  push:
    branches: [main, test-v-branch]
  pull_request:
    branches: [main, test-v-branch]

env:
  PYTHON_VERSION: '3.12'
  REPORTS_DIR: reports
  OUTPUT_DIR: agent_output
  MIN_SEVERITY: high
  LLM_ENABLED: '1'
  OLLAMA_MODEL: llama3:latest

# ==========================================================
# JOB 1: SECURITY SCANNING
# ==========================================================
jobs:
  security-scan:
    name: ðŸ” Security Scan
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Enable Debug
        run: set -x

      - name: Prepare directories
        run: mkdir -p $REPORTS_DIR

      # ---------------- SEMGREP ----------------
      - name: Run Semgrep
        continue-on-error: true
        run: |
          pip install semgrep
          semgrep scan --config=auto --json \
            --output=$REPORTS_DIR/semgrep.json . \
            || echo '{"results":[]}' > $REPORTS_DIR/semgrep.json

      # ---------------- TRIVY ----------------
      - name: Install Trivy
        run: |
          sudo apt-get update
          sudo apt-get install -y wget gnupg lsb-release
          wget -qO - https://aquasecurity.github.io/trivy-repo/deb/public.key | sudo apt-key add -
          echo deb https://aquasecurity.github.io/trivy-repo/deb $(lsb_release -sc) main \
            | sudo tee /etc/apt/sources.list.d/trivy.list
          sudo apt-get update
          sudo apt-get install -y trivy

      - name: Run Trivy FS + Image
        continue-on-error: true
        run: |
          trivy fs --format json --output $REPORTS_DIR/trivy_fs.json . \
            || echo '{"Results":[]}' > $REPORTS_DIR/trivy_fs.json

          if [ -f Dockerfile ]; then
            docker build -t scan-target .
            trivy image --format json \
              --output $REPORTS_DIR/trivy_image.json scan-target \
              || echo '{"Results":[]}' > $REPORTS_DIR/trivy_image.json
          fi

      # ---------------- TFSEC ----------------
      - name: Run tfsec
        continue-on-error: true
        run: |
          curl -s https://raw.githubusercontent.com/aquasecurity/tfsec/master/scripts/install_linux.sh | bash
          if [ -d terraform ]; then
            tfsec terraform --format json > $REPORTS_DIR/tfsec.json \
              || echo '{"results":[]}' > $REPORTS_DIR/tfsec.json
          fi

      # ---------------- GITLEAKS ----------------
      - name: Run Gitleaks
        continue-on-error: true
        run: |
          wget -qO gitleaks.tar.gz https://github.com/gitleaks/gitleaks/releases/latest/download/gitleaks_linux_x64.tar.gz
          tar -xzf gitleaks.tar.gz
          sudo mv gitleaks /usr/local/bin
          gitleaks detect --source . \
            --report-format json \
            --report-path $REPORTS_DIR/gitleaks.json \
            --no-git || echo '[]' > $REPORTS_DIR/gitleaks.json

      # ---------------- CONFTEST ----------------
      - name: Run Conftest
        continue-on-error: true
        run: |
          wget -qO conftest.tar.gz https://github.com/open-policy-agent/conftest/releases/latest/download/conftest_Linux_x86_64.tar.gz
          tar -xzf conftest.tar.gz
          sudo mv conftest /usr/local/bin

          conftest test Dockerfile -o json > $REPORTS_DIR/conftest_docker.json || echo '[]' > $REPORTS_DIR/conftest_docker.json
          conftest test k8s/ -o json > $REPORTS_DIR/conftest_k8s.json || echo '[]' > $REPORTS_DIR/conftest_k8s.json
          conftest test terraform/ -o json > $REPORTS_DIR/conftest_tf.json || echo '[]' > $REPORTS_DIR/conftest_tf.json

      - name: Upload scan reports
        uses: actions/upload-artifact@v4
        with:
          name: scan-reports
          path: $REPORTS_DIR/

# ==========================================================
# JOB 2: AGENTIC AI ANALYSIS
# ==========================================================
  ai-analysis:
    name: ðŸ¤– Agentic AI Analysis
    runs-on: ubuntu-latest
    needs: security-scan

    outputs:
      pipeline_status: ${{ steps.analyze.outputs.pipeline_status }}

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - run: pip install requests pyyaml

      - uses: actions/download-artifact@v4
        with:
          name: scan-reports
          path: $REPORTS_DIR

      - run: mkdir -p $OUTPUT_DIR

      - name: Run pipeline (DEBUG)
        id: analyze
        run: |
          set -x
          python main.py -v

          STATUS=$(jq -r '.status' $OUTPUT_DIR/decision.json)
          echo "pipeline_status=$STATUS" >> $GITHUB_OUTPUT

      - uses: actions/upload-artifact@v4
        with:
          name: ai-output
          path: $OUTPUT_DIR/

# ==========================================================
# JOB 3: CREATE REMEDIATION PR (BEST PRACTICE)
# ==========================================================
  create-pr:
    name: ðŸ”§ Create Remediation PR
    runs-on: ubuntu-latest
    needs: ai-analysis

    if: |
      github.event_name == 'push' &&
      needs.ai-analysis.outputs.pipeline_status == 'fail'

    permissions:
      contents: write
      pull-requests: write

    steps:
      - uses: actions/checkout@v4

      - name: Create PR
        run: |
          set -x
          gh pr create \
            --title "security: automated remediation" \
            --body "Agentic DevSecOps pipeline detected security issues and applied fixes." \
            --base main \
            --head ${{ github.ref_name }}
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

# ==========================================================
# JOB 4: PR COMMENT (READ-ONLY MODE)
# ==========================================================
  pr-comment:
    name: ðŸ’¬ PR Comment
    runs-on: ubuntu-latest
    needs: ai-analysis
    if: github.event_name == 'pull_request'

    permissions:
      pull-requests: write

    steps:
      - uses: actions/download-artifact@v4
        with:
          name: ai-output
          path: $OUTPUT_DIR

      - uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const body = fs.readFileSync('agent_output/pr_comment.md','utf8');
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body
            })

# ==========================================================
# JOB 5: SECURITY GATE
# ==========================================================
  gate:
    name: ðŸš¦ Security Gate
    runs-on: ubuntu-latest
    needs: ai-analysis

    steps:
      - uses: actions/download-artifact@v4
        with:
          name: ai-output
          path: $OUTPUT_DIR

      - run: |
          STATUS=$(jq -r '.status' $OUTPUT_DIR/decision.json)
          [ "$STATUS" = "fail" ] && exit 1 || echo "Gate passed"

# ==========================================================
# JOB 6: EMAIL NOTIFICATION
# ==========================================================
  notify:
    name: ðŸ“§ Email Notification
    runs-on: ubuntu-latest
    needs: [ai-analysis, gate]
    if: always()

    steps:
      - uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 587
          username: ${{ secrets.GMAIL_USERNAME }}
          password: ${{ secrets.GMAIL_APP_PASSWORD }}
          subject: "DevSecOps Scan Result"
          to: ${{ secrets.NOTIFICATION_EMAIL }}
          from: "DevSecOps Pipeline <${{ secrets.GMAIL_USERNAME }}>"
          body: "Pipeline completed. Status: ${{ needs.ai-analysis.outputs.pipeline_status }}"

