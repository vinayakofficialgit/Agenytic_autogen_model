name: DevSecOps Agentic AI Pipeline

on:
  push:
    branches: [main, test-v-branch]
  pull_request:
    branches: [main, test-v-branch]
  workflow_dispatch:

env:
  PYTHON_VERSION: "3.12"
  APP_DIR: "Order-app-main"
  REPORTS_DIR: "reports"
  OUTPUT_DIR: "agent_output"
  ACTIONS_STEP_DEBUG: "true"  
  LLM_ENABLED: ${{ secrets.LLM_ENABLED }}
  LLM_AUTOFIX: ${{ secrets.LLM_AUTOFIX }}   
  OLLAMA_MODEL: ${{ secrets.OLLAMA_MODEL }}
  OLLAMA_NUM_CTX: ${{ secrets.OLLAMA_NUM_CTX }}
  OLLAMA_NUM_PREDICT: ${{ secrets.OLLAMA_NUM_PREDICT }}
  OLLAMA_TEMPERATURE: ${{ secrets.OLLAMA_TEMPERATURE }}
  MIN_SEVERITY: ${{ secrets.MIN_SEVERITY }}
  LLM_AUTOFIX_TOOLS: ${{ secrets.LLM_AUTOFIX_TOOLS }}
  


jobs:
# ============================================================
# JOB 1: SECURITY SCANS
# ============================================================
  security-scan:
    name: ğŸ” Security Scan
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Prepare directories
        run: |
          set -e
          mkdir -p "$REPORTS_DIR"

    
      
     ## ---------------- SEMGREP (CODE) ----------------
      - name: Run Semgrep (Application)
        run: |
          set -e
          pip install semgrep
          semgrep scan \
            --config=auto \
            --json \
            --output $REPORTS_DIR/semgrep.json \
            $APP_DIR
          test -f $REPORTS_DIR/semgrep.json
      
      - name: Run Trivy FS (Application)
        run: |
          set -e
      
          curl -sfL https://raw.githubusercontent.com/aquasecurity/trivy/main/contrib/install.sh | sh
          sudo mv ./bin/trivy /usr/local/bin/trivy
      
          trivy version
      
          trivy fs \
            --format json \
            --output $REPORTS_DIR/trivy_fs.json \
            $APP_DIR
      
          test -f $REPORTS_DIR/trivy_fs.json


      # ---------------- TRIVY IMAGE (OPTIONAL APP IMAGE) ----------------
      - name: Run Trivy Image (if Dockerfile exists)
        run: |
          set -e
          if [ -f "$APP_DIR/Dockerfile" ]; then
            docker build -t order-app:scan $APP_DIR
            trivy image \
              --format json \
              --output $REPORTS_DIR/trivy_image.json \
              order-app:scan
          else
            echo '{}' > $REPORTS_DIR/trivy_image.json
          fi
          test -f $REPORTS_DIR/trivy_image.json


      # ---------------- TFSEC ----------------
      - name: Install tfsec
        run: |
          set -e
          curl -sfL https://raw.githubusercontent.com/aquasecurity/tfsec/master/scripts/install_linux.sh | bash

      - name: Run tfsec
        run: |
          set -e
          tfsec terraform --format json \
            > "$REPORTS_DIR/tfsec.json" || true
          test -f "$REPORTS_DIR/tfsec.json"

      # ---------------- GITLEAKS ----------------
      - name: Install Gitleaks
        run: |
          set -e
          sudo apt-get update
          sudo apt-get install -y jq
          VERSION=$(curl -s https://api.github.com/repos/gitleaks/gitleaks/releases/latest | jq -r .tag_name)
          curl -sL https://github.com/gitleaks/gitleaks/releases/download/${VERSION}/gitleaks_${VERSION#v}_linux_x64.tar.gz \
            | tar -xz
          sudo mv gitleaks /usr/local/bin/

      - name: Run Gitleaks
        run: |
          set -e
          gitleaks detect --source . --report-format json \
            --report-path "$REPORTS_DIR/gitleaks.json" --no-git || true
          test -f "$REPORTS_DIR/gitleaks.json"

      # ---------------- CONFTEST (POLICY) ----------------
      - name: Install Conftest
        run: |
          set -e
          sudo apt-get update
          sudo apt-get install -y jq curl
      
          VERSION=$(curl -s https://api.github.com/repos/open-policy-agent/conftest/releases/latest | jq -r .tag_name)
          echo "Installing conftest $VERSION"
      
          curl -sL https://github.com/open-policy-agent/conftest/releases/download/${VERSION}/conftest_${VERSION#v}_Linux_x86_64.tar.gz \
            | tar -xz
      
          sudo mv conftest /usr/local/bin/
          conftest --version

      - name: Run Conftest (Policies)
        run: |
            set -e
            conftest test k8s terraform policy \
              --output json \
              > "$REPORTS_DIR/conftest.json" || echo "[]" > "$REPORTS_DIR/conftest.json"
        
            test -f "$REPORTS_DIR/conftest.json"
          


      - name: Upload scan reports
        uses: actions/upload-artifact@v4
        with:
          name: scan-reports
          path: reports/




# ============================================================
# JOB 2: AI ANALYSIS (OLLAMA ENABLED)
# ============================================================
  ai-analysis:
    name: ğŸ¤– Agentic AI Analysis
    runs-on: ubuntu-latest
    needs: security-scan

    outputs:
      pipeline_status: ${{ steps.status.outputs.pipeline_status }}

    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - run: pip install pyyaml requests jq

      - uses: actions/download-artifact@v4
        with:
          name: scan-reports
          path: reports/

      # ---------- START OLLAMA ----------
      - name: Start Ollama
        run: |
          set -e
          curl -fsSL https://ollama.com/install.sh | sh
          nohup ollama serve > /tmp/ollama.log 2>&1 &
          sleep 10
          ollama pull "$OLLAMA_MODEL"

      - name: Run agentic analysis
        run: |
          python main.py --verbose || true

      - name: Capture decision
        id: status
        run: |
          STATUS=$(jq -r '.status' "$OUTPUT_DIR/decision.json")
          echo "pipeline_status=$STATUS" >> "$GITHUB_OUTPUT"

      - uses: actions/upload-artifact@v4
        with:
          name: ai-results
          path: agent_output/
          
  # ============================================================
  # JOB 3: AUTO REMEDIATION PR (AI APPLIES FIXES)
  # ============================================================
  auto-pr:
    name: ğŸ” Auto Remediation PR
    runs-on: ubuntu-latest
    needs: ai-analysis
    if: >-
      github.event_name == 'push' &&
      needs.ai-analysis.outputs.pipeline_status == 'fail'

    permissions:
      contents: write
      pull-requests: write

    steps:
      # ---- FIX 1: Full checkout with fetch-depth for clean branching ----
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # ---- FIX 2: Setup Python (was completely missing) ----
      - uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      # ---- FIX 3: Install dependencies (was completely missing) ----
      - name: Install Python dependencies
        run: pip install pyyaml requests jq

      # ---- Download AI results from previous job ----
      - uses: actions/download-artifact@v4
        with:
          name: ai-results
          path: agent_output/

      # ---- FIX 4: Ollama with health-check instead of blind sleep ----
      - name: Start Ollama
        run: |
          set -e
          curl -fsSL https://ollama.com/install.sh | sh
          nohup ollama serve > /tmp/ollama.log 2>&1 &

          echo "â³ Waiting for Ollama to be ready..."
          for i in $(seq 1 30); do
            if curl -sf http://localhost:11434/api/tags > /dev/null 2>&1; then
              echo "âœ… Ollama is ready"
              break
            fi
            echo "  attempt $i/30..."
            sleep 2
          done

          ollama pull "$OLLAMA_MODEL"

      # ---- FIX 5: Debug â€” show what AI results look like before applying ----
      - name: Debug AI results
        run: |
          echo "--- agent_output contents ---"
          ls -la agent_output/ || echo "Directory not found"
          echo "--- decision.json ---"
          cat agent_output/decision.json 2>/dev/null || echo "Not found"

      - name: Clean up unwanted files
        run: |
          echo "__pycache__/" >> .gitignore
          echo "*.pyc" >> .gitignore
          find . -type d -name __pycache__ -exec rm -rf {} + 2>/dev/null || true

      # ---- FIX 6: Use a remediation-specific flag (adjust to your main.py) ----
      # If your main.py uses the same command for analysis and remediation,
      # you may need to add a --remediate or --fix flag. Adjust as needed.
      - name: Apply agentic fixes
        run: |
          python main.py --verbose  || true

      # ---- FIX 7: Only create PR if files actually changed ----
      - name: Check for changes
        id: changes
        run: |
          if git diff --quiet; then
            echo "has_changes=false" >> "$GITHUB_OUTPUT"
            echo "âš ï¸ No file changes detected â€” skipping PR"
          else
            echo "has_changes=true" >> "$GITHUB_OUTPUT"
            echo "âœ… Changes detected â€” will create PR"
            git diff --stat
          fi
      
      
      - name: Generate unique branch name
        id: branch
        run: |
                BRANCH="auto/security-fixes-${{ github.run_number }}"
                echo "name=$BRANCH" >> "$GITHUB_OUTPUT"
                echo "Branch: $BRANCH"

      
      - name: Create remediation PR
        if: steps.changes.outputs.has_changes == 'true'
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          branch: ${{ steps.branch.outputs.name }}    
          base: test-v-branch
          delete-branch: true
          title: "ğŸ”§ Automated Security Fixes (Run #${{ github.run_number }})"
          commit-message: "fix: agentic security remediation"
          body: |
            ## ğŸ¤– Automated Security Remediation

            **Run:** #${{ github.run_number }}
            **Commit:** ${{ github.sha }}

            This PR was created automatically by the DevSecOps Agentic AI Pipeline.

            ---
            _Generated by DevSecOps Agentic AI Pipeline_


# ============================================================
  # JOB 4: GATE (runs AFTER remediation â€” final verdict)
  # ============================================================
  gate-check:
    name: ğŸš¦ Security Gate
    runs-on: ubuntu-latest
    needs: [ai-analysis, auto-pr]          # â† CHANGE 1: added auto-pr dependency
    if: always()                            # â† CHANGE 2: runs even if auto-pr was skipped

    steps:
      # â† CHANGE 3: Try remediated artifact first
      - name: Download remediated results
        id: download-remediated
        uses: actions/download-artifact@v4
        continue-on-error: true
        with:
          name: ai-results-remediated
          path: agent_output/

      # â† CHANGE 4: Fall back to original if remediation didn't run
      - name: Download original results (fallback)
        if: steps.download-remediated.outcome == 'failure'
        uses: actions/download-artifact@v4
        with:
          name: ai-results
          path: agent_output/

      # â† CHANGE 5: Better evaluation with clear messaging
      - name: Evaluate gate
        run: |
          if [ ! -f agent_output/decision.json ]; then
            echo "âŒ decision.json not found â€” failing gate"
            exit 1
          fi
          STATUS=$(jq -r '.status' agent_output/decision.json)
          echo "Final status: $STATUS"
          if [ "$STATUS" = "fail" ]; then
            echo "âŒ Security gate FAILED"
            exit 1
          fi
          echo "âœ… Security gate PASSED"

          
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # JOB 5: Gmail Email Notification
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  email-notification:
    name: ğŸ“§ Gmail Notification
    runs-on: ubuntu-latest
    needs: [ai-analysis, gate-check]
    if: always()
    
    steps:
      - name: ğŸ“§ Prepare & Send Email
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 587
          username: ${{ secrets.GMAIL_USERNAME }}
          password: ${{ secrets.GMAIL_APP_PASSWORD }}
          subject: "${{ needs.ai-analysis.outputs.pipeline_status == 'fail' && 'ğŸ”´ [SECURITY ALERT]' || 'ğŸŸ¢ [SECURITY OK]' }} ${{ github.repository }} - ${{ github.ref_name }}"
          to: ${{ secrets.NOTIFICATION_EMAIL }}
          from: "Agentic Pipeline DevSecOps Pipeline Vinayak<${{ secrets.GMAIL_USERNAME }}>"
          body: |
            â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                        DevSecOps Security Scan Report
            â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            
            Status:     ${{ needs.ai-analysis.outputs.pipeline_status == 'fail' && 'âŒ FAILED' || 'âœ… PASSED' }}
            Repository: ${{ github.repository }}
            Branch:     ${{ github.ref_name }}
            Commit:     ${{ github.sha }}
            Actor:      ${{ github.actor }}
            
            â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
                                SCAN RESULTS
            â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            
            Total Findings: ${{ needs.ai-analysis.outputs.total_findings }}
            
            ğŸ”´ Critical:    ${{ needs.ai-analysis.outputs.critical_count }}
            ğŸŸ  High:        ${{ needs.ai-analysis.outputs.high_count }}
            ğŸŸ¡ Medium:      ${{ needs.ai-analysis.outputs.medium_count }}
            
            Reason: ${{ needs.ai-analysis.outputs.reason }}
            
            â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
                                    LINKS
            â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            
            ğŸ“‹ View Run:    https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}
            ğŸ“ View Commit: https://github.com/${{ github.repository }}/commit/${{ github.sha }}
            
            ${{ needs.ai-analysis.outputs.pipeline_status == 'fail' && 'âš ï¸  ACTION REQUIRED: Please fix security issues before merging.' || 'âœ… All security checks passed.' }}
            
            â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            DevSecOps Agentic AI Pipeline | Automated Security Scanning
          priority: ${{ needs.ai-analysis.outputs.pipeline_status == 'fail' && 'high' || 'normal' }}
