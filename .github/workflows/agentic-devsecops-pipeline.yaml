name: DevSecOps Agentic AI Pipeline

on:
  push:
    branches: [feature/AgentAI]
  pull_request:
  workflow_dispatch:

permissions:
  contents: read

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  PYTHON_VERSION: "3.12"
  APP_DIR: "Order-app-main"
  REPORTS_DIR: "reports"
  OUTPUT_DIR: "agent_output"
  ACTIONS_STEP_DEBUG: "true"

  # LLM params (keep non-sensitive ones visible unless you need to hide them)
  LLM_ENABLED: ${{ vars.LLM_ENABLED || '1' }}
  LLM_AUTOFIX: ${{ vars.LLM_AUTOFIX || '1' }}
  OLLAMA_MODEL: ${{ vars.OLLAMA_MODEL || 'llama3:8b-instruct-q5_K_M' }}
  OLLAMA_NUM_CTX: ${{ vars.OLLAMA_NUM_CTX || '4096' }}
  OLLAMA_NUM_PREDICT: ${{ vars.OLLAMA_NUM_PREDICT || '1024' }}
  OLLAMA_TEMPERATURE: ${{ vars.OLLAMA_TEMPERATURE || '0.2' }}
  MIN_SEVERITY: ${{ vars.MIN_SEVERITY || 'high' }}
  LLM_AUTOFIX_TOOLS: ${{ vars.LLM_AUTOFIX_TOOLS || 'trivy_fs,semgrep,conftest,gitleaks' }}
  NO_PROXY: "127.0.0.1,localhost"

jobs:
  security-scan:
    name: "ðŸ” Security Scan"
    runs-on: ubuntu-22.04
    timeout-minutes: 45

    steps:
      - uses: actions/checkout@v4

      - name: Prepare directories
        run: |
          set -Eeuo pipefail
          mkdir -p "$REPORTS_DIR"

      # SEMGREP (pin version)
      - name: Install Semgrep
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
      - run: pip install "semgrep==1.83.0"
      - name: Run Semgrep
        continue-on-error: true
        run: |
          set -Eeuo pipefail
          semgrep scan --config=auto --json --output "$REPORTS_DIR/semgrep.json" "$APP_DIR"
          test -f "$REPORTS_DIR/semgrep.json"

      # TRIVY FS (use official install; pin release)
      - name: Install Trivy
        run: |
          set -Eeuo pipefail
          curl -sfL https://raw.githubusercontent.com/aquasecurity/trivy/main/contrib/install.sh | sh -s -- -b /usr/local/bin v0.54.1
          trivy --version

      - name: Run Trivy FS
        continue-on-error: true
        run: |
          set -Eeuo pipefail
          trivy fs --format json --output "$REPORTS_DIR/trivy_fs.json" "$APP_DIR"
          test -f "$REPORTS_DIR/trivy_fs.json"

      # TRIVY IMAGE (optional)
      - name: Run Trivy Image (if Dockerfile exists)
        continue-on-error: true
        run: |
          set -Eeuo pipefail
          if [ -f "$APP_DIR/Dockerfile" ]; then
            docker build -t order-app:scan "$APP_DIR"
            trivy image --format json --output "$REPORTS_DIR/trivy_image.json" order-app:scan
          else
            echo '{}' > "$REPORTS_DIR/trivy_image.json"
          fi
          test -f "$REPORTS_DIR/trivy_image.json"

      # GITLEAKS
      - name: Install Gitleaks
        run: |
          set -Eeuo pipefail
          sudo apt-get update
          sudo apt-get install -y jq
          VERSION=$(curl -s https://api.github.com/repos/gitleaks/gitleaks/releases/latest | jq -r .tag_name)
          curl -sL "https://github.com/gitleaks/gitleaks/releases/download/${VERSION}/gitleaks_${VERSION#v}_linux_x64.tar.gz" | tar -xz
          sudo mv gitleaks /usr/local/bin/

      - name: Run Gitleaks
        continue-on-error: true
        run: |
          set -Eeuo pipefail
          gitleaks detect --source . --report-format json --report-path "$REPORTS_DIR/gitleaks.json" --no-git || true
          test -f "$REPORTS_DIR/gitleaks.json"

      # CONFTEST
      - name: Install Conftest
        run: |
          set -Eeuo pipefail
          sudo apt-get update && sudo apt-get install -y jq curl
          VERSION=$(curl -s https://api.github.com/repos/open-policy-agent/conftest/releases/latest | jq -r .tag_name)
          curl -sL "https://github.com/open-policy-agent/conftest/releases/download/${VERSION}/conftest_${VERSION#v}_Linux_x86_64.tar.gz" | tar -xz
          sudo mv conftest /usr/local/bin/
          conftest --version

      - name: Run Conftest (Policies)
        continue-on-error: true
        run: |
          set -Eeuo pipefail
          conftest test k8s terraform policy --output json > "$REPORTS_DIR/conftest.json" || echo "[]" > "$REPORTS_DIR/conftest.json"
          test -f "$REPORTS_DIR/conftest.json"

      - name: Upload scan reports
        uses: actions/upload-artifact@v4
        with:
          name: scan-reports
          path: reports/
          retention-days: 7