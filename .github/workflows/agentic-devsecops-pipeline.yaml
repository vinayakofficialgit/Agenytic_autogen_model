name: DevSecOps Agentic AI Pipeline

on:
  push:
    branches: [main, test-v-branch]
  pull_request:
    branches: [main, test-v-branch]
  workflow_dispatch:

env:
  PYTHON_VERSION: "3.12"
  APP_DIR: "Order-app-main"
  REPORTS_DIR: "reports"
  OUTPUT_DIR: "agent_output"
  MIN_SEVERITY: "high"
  ACTIONS_STEP_DEBUG: "true"

jobs:
# ============================================================
# JOB 1: SECURITY SCANS
# ============================================================
  security-scan:
    name: üîç Security Scan
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Prepare directories
        run: |
          set -e
          mkdir -p "$REPORTS_DIR"

    
      
      # ---------------- SEMGREP (CODE) ----------------
      # - name: Run Semgrep (Application)
      #   run: |
      #     set -e
      #     pip install semgrep
      #     semgrep scan \
      #       --config=auto \
      #       --json \
      #       --output $REPORTS_DIR/semgrep.json \
      #       $APP_DIR
      #     test -f $REPORTS_DIR/semgrep.json
      
      # - name: Run Trivy FS (Application)
      #   run: |
      #     set -e
      
      #     curl -sfL https://raw.githubusercontent.com/aquasecurity/trivy/main/contrib/install.sh | sh
      #     sudo mv ./bin/trivy /usr/local/bin/trivy
      
      #     trivy version
      
      #     trivy fs \
      #       --format json \
      #       --output $REPORTS_DIR/trivy_fs.json \
      #       $APP_DIR
      
      #     test -f $REPORTS_DIR/trivy_fs.json


      # # ---------------- TRIVY IMAGE (OPTIONAL APP IMAGE) ----------------
      # - name: Run Trivy Image (if Dockerfile exists)
      #   run: |
      #     set -e
      #     if [ -f "$APP_DIR/Dockerfile" ]; then
      #       docker build -t order-app:scan $APP_DIR
      #       trivy image \
      #         --format json \
      #         --output $REPORTS_DIR/trivy_image.json \
      #         order-app:scan
      #     else
      #       echo '{}' > $REPORTS_DIR/trivy_image.json
      #     fi
      #     test -f $REPORTS_DIR/trivy_image.json


      # ---------------- TFSEC ----------------
      - name: Install tfsec
        run: |
          set -e
          curl -sfL https://raw.githubusercontent.com/aquasecurity/tfsec/master/scripts/install_linux.sh | bash

      - name: Run tfsec
        run: |
          set -e
          tfsec terraform --format json \
            > "$REPORTS_DIR/tfsec.json" || true
          test -f "$REPORTS_DIR/tfsec.json"

      # ---------------- GITLEAKS ----------------
      - name: Install Gitleaks
        run: |
          set -e
          sudo apt-get update
          sudo apt-get install -y jq
          VERSION=$(curl -s https://api.github.com/repos/gitleaks/gitleaks/releases/latest | jq -r .tag_name)
          curl -sL https://github.com/gitleaks/gitleaks/releases/download/${VERSION}/gitleaks_${VERSION#v}_linux_x64.tar.gz \
            | tar -xz
          sudo mv gitleaks /usr/local/bin/

      - name: Run Gitleaks
        run: |
          set -e
          gitleaks detect --source . --report-format json \
            --report-path "$REPORTS_DIR/gitleaks.json" --no-git || true
          test -f "$REPORTS_DIR/gitleaks.json"

      # ---------------- CONFTEST (POLICY) ----------------
      - name: Install Conftest
        run: |
          set -e
          sudo apt-get update
          sudo apt-get install -y jq curl
      
          VERSION=$(curl -s https://api.github.com/repos/open-policy-agent/conftest/releases/latest | jq -r .tag_name)
          echo "Installing conftest $VERSION"
      
          curl -sL https://github.com/open-policy-agent/conftest/releases/download/${VERSION}/conftest_${VERSION#v}_Linux_x86_64.tar.gz \
            | tar -xz
      
          sudo mv conftest /usr/local/bin/
          conftest --version

       - name: Run Conftest (Policies)
         run: |
            set -e
            conftest test k8s terraform policy \
              --output json \
              > "$REPORTS_DIR/conftest.json" || echo "[]" > "$REPORTS_DIR/conftest.json"
        
            test -f "$REPORTS_DIR/conftest.json"
          


      - name: Upload scan reports
        uses: actions/upload-artifact@v4
        with:
          name: scan-reports
          path: reports/

# ============================================================
# JOB 2: AGENTIC AI
# ============================================================
  ai-analysis:
    name: ü§ñ Agentic AI Analysis
    runs-on: ubuntu-latest
    needs: security-scan

    outputs:
      pipeline_status: ${{ steps.analyze.outputs.pipeline_status }}

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install Python deps
        run: pip install pyyaml requests jq

      - uses: actions/download-artifact@v4
        with:
          name: scan-reports
          path: reports/

      - name: Run Agentic Pipeline
        id: analyze
        run: |
          set -e
          python main.py -v
          STATUS=$(jq -r '.status' "$OUTPUT_DIR/decision.json")
          echo "pipeline_status=$STATUS" >> "$GITHUB_OUTPUT"

      - uses: actions/upload-artifact@v4
        with:
          name: ai-results
          path: agent_output/

# ============================================================
# JOB 3: AUTO PR
# ============================================================
  auto-pr:
    name: üîÅ Auto Remediation PR
    runs-on: ubuntu-latest
    needs: ai-analysis
    if: github.event_name == 'push' && needs.ai-analysis.outputs.pipeline_status == 'fail'

    permissions:
      contents: write
      pull-requests: write

    steps:
      - uses: actions/checkout@v4
      - uses: actions/download-artifact@v4
        with:
          name: ai-results
          path: agent_output/
      - run: python main.py --skip-llm
      - uses: peter-evans/create-pull-request@v6
        with:
          branch: auto/security-fixes
          title: "üîß Automated Security Fixes"

# ============================================================
# JOB 4: GATE
# ============================================================
  gate-check:
    name: üö¶ Security Gate
    runs-on: ubuntu-latest
    needs: ai-analysis

    steps:
      - uses: actions/download-artifact@v4
        with:
          name: ai-results
          path: agent_output/
      - run: |
          STATUS=$(jq -r '.status' agent_output/decision.json)
          [ "$STATUS" = "fail" ] && exit 1

# ============================================================
# JOB 5: EMAIL
# ============================================================
  email-notification:
    name: üìß Gmail Notification
    runs-on: ubuntu-latest
    needs: [ai-analysis, gate-check]
    if: always()

    steps:
      - uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 587
          username: ${{ secrets.GMAIL_USERNAME }}
          password: ${{ secrets.GMAIL_APP_PASSWORD }}
          to: ${{ secrets.NOTIFICATION_EMAIL }}
          subject: "Security Pipeline Result"
          body: "Status: ${{ needs.ai-analysis.outputs.pipeline_status }}"
