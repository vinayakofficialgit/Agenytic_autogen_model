###########################
name: DevSecOps Agentic AI Pipeline

on:
  push:
    branches: [test-s-branch]
  pull_request:
    branches: [test-s-branch]
  workflow_dispatch:

env:
  PYTHON_VERSION: "3.12"
  APP_DIR: "Order-app-main"
  REPORTS_DIR: "reports"
  OUTPUT_DIR: "agent_output"
  ACTIONS_STEP_DEBUG: "true"
  LLM_ENABLED: ${{ secrets.LLM_ENABLED }}
  LLM_AUTOFIX: ${{ secrets.LLM_AUTOFIX }}
  OLLAMA_MODEL: "qwen2.5-coder:1.5b"
  OLLAMA_NUM_CTX: ${{ secrets.OLLAMA_NUM_CTX }}
  OLLAMA_NUM_PREDICT: ${{ secrets.OLLAMA_NUM_PREDICT }}
  OLLAMA_TEMPERATURE: ${{ secrets.OLLAMA_TEMPERATURE }}
  MIN_SEVERITY: "critical"
  LLM_AUTOFIX_TOOLS: ${{ secrets.LLM_AUTOFIX_TOOLS }}

jobs:
# ============================================================
# JOB 1: SECURITY SCANS
# ============================================================
  security-scan:
    name: ðŸ” Security Scan
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Setup Python & Venv
        run: |
          sudo apt update && sudo apt install -y python3-venv
          python3 -m venv envmine
          echo "$GITHUB_WORKSPACE/envmine/bin" >> $GITHUB_PATH

      # â”€â”€ Cache pip packages â”€â”€
      - name: Cache pip packages
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/pip
            ${{ github.workspace }}/envmine
          key: scan-pip-${{ hashFiles('requirements.txt') }}
          restore-keys: |
            scan-pip-

      - name: Install Dependencies
        run: |
          pip install -r requirements.txt

      # â”€â”€ Cache security tool binaries â”€â”€
      - name: Cache security tools
        id: tool-cache
        uses: actions/cache@v4
        with:
          path: |
            /usr/local/bin/trivy
            /usr/local/bin/tfsec
            /usr/local/bin/gitleaks
            /usr/local/bin/conftest
          key: security-tools-v2-${{ runner.os }}

      ## ---------------- SEMGREP (CODE) ----------------
      - name: Run Semgrep (Application)
        run: |
          set -e
          pip install semgrep
          semgrep scan \
            --config=auto \
            --json \
            --output $REPORTS_DIR/semgrep.json \
            $APP_DIR
          test -f $REPORTS_DIR/semgrep.json

      ## ---------------- TRIVY FS ----------------
      - name: Install Trivy
        if: steps.tool-cache.outputs.cache-hit != 'true'
        run: |
          set -e
          curl -sfL https://raw.githubusercontent.com/aquasecurity/trivy/main/contrib/install.sh | sh
          sudo mv ./bin/trivy /usr/local/bin/trivy

      - name: Run Trivy FS (Application)
        run: |
          set -e
          trivy version
          trivy fs \
            --format json \
            --output $REPORTS_DIR/trivy_fs.json \
            $APP_DIR
          test -f $REPORTS_DIR/trivy_fs.json

      # ---------------- TRIVY IMAGE ----------------
      - name: Run Trivy Image (if Dockerfile exists)
        run: |
          set -e
          if [ -f "$APP_DIR/Dockerfile" ]; then
            docker build -t order-app:scan $APP_DIR
            trivy image \
              --format json \
              --output $REPORTS_DIR/trivy_image.json \
              order-app:scan
          else
            echo '{}' > $REPORTS_DIR/trivy_image.json
          fi
          test -f $REPORTS_DIR/trivy_image.json

      # ---------------- TFSEC ----------------
      - name: Install tfsec
        if: steps.tool-cache.outputs.cache-hit != 'true'
        run: |
          set -e
          curl -sfL https://raw.githubusercontent.com/aquasecurity/tfsec/master/scripts/install_linux.sh | bash

      - name: Run tfsec
        run: |
          set -e
          tfsec terraform --format json \
            > "$REPORTS_DIR/tfsec.json" || true
          test -f "$REPORTS_DIR/tfsec.json"

      # ---------------- GITLEAKS ----------------
      - name: Install Gitleaks
        if: steps.tool-cache.outputs.cache-hit != 'true'
        run: |
          set -e
          sudo apt-get update
          sudo apt-get install -y jq
          VERSION=$(curl -s https://api.github.com/repos/gitleaks/gitleaks/releases/latest | jq -r .tag_name)
          curl -sL https://github.com/gitleaks/gitleaks/releases/download/${VERSION}/gitleaks_${VERSION#v}_linux_x64.tar.gz \
            | tar -xz
          sudo mv gitleaks /usr/local/bin/

      - name: Run Gitleaks
        run: |
          set -e
          gitleaks detect --source . --report-format json \
            --report-path "$REPORTS_DIR/gitleaks.json" --no-git || true
          test -f "$REPORTS_DIR/gitleaks.json"

      # ---------------- CONFTEST (POLICY) ----------------
      - name: Install Conftest
        if: steps.tool-cache.outputs.cache-hit != 'true'
        run: |
          set -e
          sudo apt-get update
          sudo apt-get install -y jq curl
          VERSION=$(curl -s https://api.github.com/repos/open-policy-agent/conftest/releases/latest | jq -r .tag_name)
          echo "Installing conftest $VERSION"
          curl -sL https://github.com/open-policy-agent/conftest/releases/download/${VERSION}/conftest_${VERSION#v}_Linux_x86_64.tar.gz \
            | tar -xz
          sudo mv conftest /usr/local/bin/
          conftest --version

      - name: Run Conftest (Policies)
        run: |
          set -e
          mkdir -p "$REPORTS_DIR"
          
          conftest test app/Dockerfile -p policy --output json > "$REPORTS_DIR/conftest-docker.json" || echo "[]" > "$REPORTS_DIR/conftest-docker.json"
          
          test -f "$REPORTS_DIR/conftest-docker.json"
          
          conftest test k8s/deployment.yaml -p policy --output json > "$REPORTS_DIR/conftest-k8s.json" || echo "[]" > "$REPORTS_DIR/conftest-k8s.json"
          test -f "$REPORTS_DIR/conftest-k8s.json"

          conftest test terraform/ -p policy --output json > "$REPORTS_DIR/conftest-terraform.json" || echo "[]" > "$REPORTS_DIR/conftest-terraform.json"
          test -f "$REPORTS_DIR/conftest-terraform.json"

          # conftest test app k8s terraform  \
          #   -p policy \
          #   --output json \
          #   > "$REPORTS_DIR/conftest.json" || echo "[]" > "$REPORTS_DIR/conftest.json"
          # test -f "$REPORTS_DIR/conftest.json"

      - name: Upload scan reports
        uses: actions/upload-artifact@v4
        with:
          name: scan-reports
          path: reports/
