# .github/workflows/devsecops-pipeline.yml
# DevSecOps Agentic AI Pipeline - GitHub Actions Workflow
#


name: DevSecOps Security Scan

on:
  push:
    branches: [main, test-v-branch]
  pull_request:
    branches: [main, test-v-branch]
  # schedule:
  #   - cron: '0 6 * * 1'
  # workflow_dispatch:

env:
  PYTHON_VERSION: '3.12'
  REPORTS_DIR: 'reports'
  OUTPUT_DIR: 'agent_output'
  LLM_ENABLED: '1'
  OLLAMA_MODEL: 'llama3:latest'
  MIN_SEVERITY: 'high'

jobs:
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # JOB 1: Security Scanning
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  security-scan:
    name: ğŸ” Security Scan
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸ“ Create Reports Directory
        run: mkdir -p ${{ env.REPORTS_DIR }}

      # SEMGREP
      - name: ğŸ”¬ Install & Run Semgrep
        continue-on-error: true
        run: |
          pip install semgrep
          semgrep scan --config=auto --json --output=${{ env.REPORTS_DIR }}/semgrep.json . 2>/dev/null || echo '{"results":[]}' > ${{ env.REPORTS_DIR }}/semgrep.json

      # TRIVY
      - name: ğŸ³ Install Trivy
        run: |
          sudo apt-get install -y wget apt-transport-https gnupg lsb-release
          wget -qO - https://aquasecurity.github.io/trivy-repo/deb/public.key | sudo apt-key add -
          echo deb https://aquasecurity.github.io/trivy-repo/deb $(lsb_release -sc) main | sudo tee -a /etc/apt/sources.list.d/trivy.list
          sudo apt-get update
          sudo apt-get install -y trivy

      - name: ğŸ³ Run Trivy Scans
        continue-on-error: true
        run: |
          trivy fs --format json --output ${{ env.REPORTS_DIR }}/trivy.json . 2>/dev/null || echo '{"Results":[]}' > ${{ env.REPORTS_DIR }}/trivy.json
          if [ -f "Dockerfile" ] || [ -f "app/Dockerfile" ]; then
            docker build -t scan-target:latest . 2>/dev/null || true
            trivy image --format json --output ${{ env.REPORTS_DIR }}/trivy-image.json scan-target:latest 2>/dev/null || echo '{"Results":[]}' > ${{ env.REPORTS_DIR }}/trivy-image.json
          else
            echo '{"Results":[]}' > ${{ env.REPORTS_DIR }}/trivy-image.json
          fi

      # TFSEC
      - name: â˜ï¸ Install & Run tfsec
        continue-on-error: true
        run: |
          curl -s https://raw.githubusercontent.com/aquasecurity/tfsec/master/scripts/install_linux.sh | bash || true
          if [ -d "terraform" ]; then
            tfsec terraform/ --format json > ${{ env.REPORTS_DIR }}/tfsec.json 2>/dev/null || echo '{"results":[]}' > ${{ env.REPORTS_DIR }}/tfsec.json
          else
            echo '{"results":[]}' > ${{ env.REPORTS_DIR }}/tfsec.json
          fi

      # GITLEAKS
      - name: ğŸ”‘ Install & Run Gitleaks
        continue-on-error: true
        run: |
          GITLEAKS_VERSION=$(curl -s https://api.github.com/repos/gitleaks/gitleaks/releases/latest | grep '"tag_name":' | sed -E 's/.*"v([^"]+)".*/\1/' || echo "8.18.4")
          wget -qO gitleaks.tar.gz "https://github.com/gitleaks/gitleaks/releases/download/v${GITLEAKS_VERSION}/gitleaks_${GITLEAKS_VERSION}_linux_x64.tar.gz" || true
          [ -f gitleaks.tar.gz ] && tar -xzf gitleaks.tar.gz && sudo mv gitleaks /usr/local/bin/
          gitleaks detect --source . --report-format json --report-path ${{ env.REPORTS_DIR }}/gitleaks.json --no-git 2>/dev/null || echo '[]' > ${{ env.REPORTS_DIR }}/gitleaks.json

      # CONFTEST
      - name: ğŸ“‹ Install & Run Conftest
        continue-on-error: true
        run: |
          CONFTEST_VERSION=$(curl -s https://api.github.com/repos/open-policy-agent/conftest/releases/latest | grep '"tag_name":' | sed -E 's/.*"v([^"]+)".*/\1/' || echo "0.49.1")
          wget -qO conftest.tar.gz "https://github.com/open-policy-agent/conftest/releases/download/v${CONFTEST_VERSION}/conftest_${CONFTEST_VERSION}_Linux_x86_64.tar.gz" || true
          [ -f conftest.tar.gz ] && tar -xzf conftest.tar.gz 2>/dev/null && sudo mv conftest /usr/local/bin/ 2>/dev/null || true
          
          echo '[]' > ${{ env.REPORTS_DIR }}/conftest-dockerfile.json
          echo '[]' > ${{ env.REPORTS_DIR }}/conftest-k8s.json
          echo '[]' > ${{ env.REPORTS_DIR }}/conftest-terraform.json

      - name: ğŸ“¤ Upload Scan Reports
        uses: actions/upload-artifact@v4
        with:
          name: security-reports
          path: ${{ env.REPORTS_DIR }}/
          retention-days: 30

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # JOB 2: AI Analysis
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  ai-analysis:
    name: ğŸ¤– AI Analysis
    runs-on: ubuntu-latest
    needs: security-scan
    
    outputs:
      pipeline_status: ${{ steps.analysis.outputs.pipeline_status }}
      total_findings: ${{ steps.analysis.outputs.total_findings }}
      critical_count: ${{ steps.analysis.outputs.critical_count }}
      high_count: ${{ steps.analysis.outputs.high_count }}
      medium_count: ${{ steps.analysis.outputs.medium_count }}
      reason: ${{ steps.analysis.outputs.reason }}
    
    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: ğŸ Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: ğŸ“¦ Install Dependencies
        run: pip install requests pyyaml

      - name: ğŸ“¥ Download Scan Reports
        uses: actions/download-artifact@v4
        with:
          name: security-reports
          path: ${{ env.REPORTS_DIR }}/

      - name: ğŸ“ Create Output Directory
        run: mkdir -p ${{ env.OUTPUT_DIR }}

      - name: ğŸ¤– Setup Ollama (Optional)
        continue-on-error: true
        timeout-minutes: 10
        run: |
          curl -fsSL https://ollama.com/install.sh | sh || true
          nohup ollama serve > /dev/null 2>&1 &
          sleep 10
          timeout 300 ollama pull llama3:8b-instruct-q4_0 || true

      - name: ğŸ”¬ Run AI Analysis Pipeline
        id: analysis
        run: |
          python main.py || true
          
          if [ -f "${{ env.OUTPUT_DIR }}/decision.json" ]; then
            echo "pipeline_status=$(python3 -c "import json; print(json.load(open('${{ env.OUTPUT_DIR }}/decision.json')).get('status','ok'))")" >> $GITHUB_OUTPUT
            echo "total_findings=$(python3 -c "import json; print(json.load(open('${{ env.OUTPUT_DIR }}/decision.json')).get('stats',{}).get('total',0))")" >> $GITHUB_OUTPUT
            echo "critical_count=$(python3 -c "import json; print(json.load(open('${{ env.OUTPUT_DIR }}/decision.json')).get('stats',{}).get('by_severity',{}).get('critical',0))")" >> $GITHUB_OUTPUT
            echo "high_count=$(python3 -c "import json; print(json.load(open('${{ env.OUTPUT_DIR }}/decision.json')).get('stats',{}).get('by_severity',{}).get('high',0))")" >> $GITHUB_OUTPUT
            echo "medium_count=$(python3 -c "import json; print(json.load(open('${{ env.OUTPUT_DIR }}/decision.json')).get('stats',{}).get('by_severity',{}).get('medium',0))")" >> $GITHUB_OUTPUT
            echo "reason=$(python3 -c "import json; print(json.load(open('${{ env.OUTPUT_DIR }}/decision.json')).get('reason','N/A'))")" >> $GITHUB_OUTPUT
          else
            echo "pipeline_status=ok" >> $GITHUB_OUTPUT
            echo "total_findings=0" >> $GITHUB_OUTPUT
            echo "critical_count=0" >> $GITHUB_OUTPUT
            echo "high_count=0" >> $GITHUB_OUTPUT
            echo "medium_count=0" >> $GITHUB_OUTPUT
            echo "reason=No issues found" >> $GITHUB_OUTPUT
          fi

      - name: ğŸ“¤ Upload Analysis Results
        uses: actions/upload-artifact@v4
        with:
          name: ai-analysis-results
          path: ${{ env.OUTPUT_DIR }}/
          retention-days: 30

      - name: ğŸ“Š Job Summary
        run: |
          echo "## ğŸ›¡ï¸ Security Scan Results" >> $GITHUB_STEP_SUMMARY
          [ -f "${{ env.OUTPUT_DIR }}/pr_comment.md" ] && cat ${{ env.OUTPUT_DIR }}/pr_comment.md >> $GITHUB_STEP_SUMMARY

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # JOB 3: PR Comment
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  pr-comment:
    name: ğŸ’¬ PR Comment
    runs-on: ubuntu-latest
    needs: ai-analysis
    if: github.event_name == 'pull_request'
    permissions:
      pull-requests: write
    
    steps:
      - uses: actions/download-artifact@v4
        with:
          name: ai-analysis-results
          path: ${{ env.OUTPUT_DIR }}/

      - uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            let comment = '## ğŸ›¡ï¸ Security Scan Results\n\n';
            if (fs.existsSync('${{ env.OUTPUT_DIR }}/pr_comment.md')) {
              comment += fs.readFileSync('${{ env.OUTPUT_DIR }}/pr_comment.md', 'utf8');
            }
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # JOB 4: Security Gate
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  gate-check:
    name: ğŸš¦ Security Gate
    runs-on: ubuntu-latest
    needs: ai-analysis
    
    steps:
      - uses: actions/download-artifact@v4
        with:
          name: ai-analysis-results
          path: ${{ env.OUTPUT_DIR }}/

      - name: ğŸš¦ Check Gate
        run: |
          if [ -f "${{ env.OUTPUT_DIR }}/decision.json" ]; then
            STATUS=$(python3 -c "import json; print(json.load(open('${{ env.OUTPUT_DIR }}/decision.json')).get('status','ok'))")
            [ "$STATUS" = "fail" ] && echo "âŒ FAILED" && exit 1
          fi
          echo "âœ… PASSED"

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # JOB 5: Gmail Email Notification
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  email-notification:
    name: ğŸ“§ Gmail Notification
    runs-on: ubuntu-latest
    needs: [ai-analysis, gate-check]
    if: always()
    
    steps:
      - name: ğŸ“§ Prepare & Send Email
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 587
          username: ${{ secrets.GMAIL_USERNAME }}
          password: ${{ secrets.GMAIL_APP_PASSWORD }}
          subject: "${{ needs.ai-analysis.outputs.pipeline_status == 'fail' && 'ğŸ”´ [SECURITY ALERT]' || 'ğŸŸ¢ [SECURITY OK]' }} ${{ github.repository }} - ${{ github.ref_name }}"
          to: ${{ secrets.NOTIFICATION_EMAIL }}
          from: "Agentic Pipeline DevSecOps Pipeline Vinayak<${{ secrets.GMAIL_USERNAME }}>"
          body: |
            â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                        DevSecOps Security Scan Report
            â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            
            Status:     ${{ needs.ai-analysis.outputs.pipeline_status == 'fail' && 'âŒ FAILED' || 'âœ… PASSED' }}
            Repository: ${{ github.repository }}
            Branch:     ${{ github.ref_name }}
            Commit:     ${{ github.sha }}
            Actor:      ${{ github.actor }}
            
            â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
                                SCAN RESULTS
            â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            
            Total Findings: ${{ needs.ai-analysis.outputs.total_findings }}
            
            ğŸ”´ Critical:    ${{ needs.ai-analysis.outputs.critical_count }}
            ğŸŸ  High:        ${{ needs.ai-analysis.outputs.high_count }}
            ğŸŸ¡ Medium:      ${{ needs.ai-analysis.outputs.medium_count }}
            
            Reason: ${{ needs.ai-analysis.outputs.reason }}
            
            â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
                                    LINKS
            â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            
            ğŸ“‹ View Run:    https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}
            ğŸ“ View Commit: https://github.com/${{ github.repository }}/commit/${{ github.sha }}
            
            ${{ needs.ai-analysis.outputs.pipeline_status == 'fail' && 'âš ï¸  ACTION REQUIRED: Please fix security issues before merging.' || 'âœ… All security checks passed.' }}
            
            â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            DevSecOps Agentic AI Pipeline | Automated Security Scanning
          priority: ${{ needs.ai-analysis.outputs.pipeline_status == 'fail' && 'high' || 'normal' }}
