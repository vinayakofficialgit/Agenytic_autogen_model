# ============================================================
# Deploy DevSecOps Chatbot to AWS EC2
#
# PREREQUISITES:
#   1. EC2 instance running (Ubuntu)
#   2. ECR repository created
#   3. GitHub Secrets configured (see below)
#
# REQUIRED GITHUB SECRETS:
#   AWS_ACCESS_KEY_ID       - AWS IAM access key
#   AWS_SECRET_ACCESS_KEY   - AWS IAM secret key
#   AWS_REGION              - e.g. ap-south-1 (Mumbai)
#   AWS_ACCOUNT_ID          - Your AWS account ID (12 digits)
#   ECR_REPOSITORY          - ECR repo name e.g. devsecops-chatbot
#   EC2_HOST                - EC2 Elastic IP or hostname
#   EC2_SSH_KEY             - Private SSH key (PEM content)
#   EC2_USER                - EC2 username (ubuntu / ec2-user)
#   GROQ_API_KEY            - Groq API key for the chatbot
#   GH_PAT_TOKEN            - GitHub PAT for fetching artifacts
# ============================================================
name: ðŸš€ Deploy DevSecOps Chatbot

on:
  push:
    branches: [main, test-v-branch]
    paths:
      - 'devsecops-chatbot/**'
  workflow_dispatch:

env:
  IMAGE_NAME: devsecops-chatbot
  CONTAINER_NAME: devsecops-chatbot

jobs:
  build-and-deploy:
    name: ðŸ³ Build & Deploy to EC2
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      # â”€â”€ Verify chatbot files exist â”€â”€
      - name: Verify chatbot files
        run: |
          echo "=== Files in devsecops-chatbot/ ==="
          ls -la devsecops-chatbot/
          echo ""
          echo "=== .streamlit/ ==="
          ls -la devsecops-chatbot/.streamlit/ 2>/dev/null || echo "No .streamlit folder"
          echo ""
          for f in App.py Dockerfile Requirements.txt; do
            if [ ! -f "devsecops-chatbot/$f" ]; then
              echo "âŒ MISSING: devsecops-chatbot/$f"
              exit 1
            fi
          done
          echo "âœ… All required files present"

      # â”€â”€ Login to Amazon ECR â”€â”€
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: Login to Amazon ECR
        id: ecr-login
        uses: aws-actions/amazon-ecr-login@v2

      # â”€â”€ Build & Push Docker Image â”€â”€
      - name: Build and push Docker image
        env:
          ECR_REGISTRY: ${{ steps.ecr-login.outputs.registry }}
          ECR_REPOSITORY: ${{ secrets.ECR_REPOSITORY }}
          IMAGE_TAG: ${{ github.sha }}
        run: |
          cd devsecops-chatbot

          # Build image
          docker build -t $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG .
          docker tag $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG $ECR_REGISTRY/$ECR_REPOSITORY:latest

          # Push both tags
          docker push $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG
          docker push $ECR_REGISTRY/$ECR_REPOSITORY:latest

          echo "image=$ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG" >> "$GITHUB_OUTPUT"

      # â”€â”€ Setup Docker & AWS CLI on EC2 (idempotent) â”€â”€
      - name: Setup EC2 prerequisites
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            set -e

            # â”€â”€ Install Docker if not present â”€â”€
            if ! command -v docker &> /dev/null; then
              echo "ðŸ“¦ Installing Docker..."
              sudo apt-get update
              sudo apt-get install -y docker.io
              sudo systemctl enable docker
              sudo systemctl start docker
              sudo usermod -aG docker $USER
              echo "âœ… Docker installed"
            else
              echo "âœ… Docker already installed: $(docker --version)"
            fi

            # â”€â”€ Install AWS CLI if not present â”€â”€
            if ! command -v aws &> /dev/null; then
              echo "ðŸ“¦ Installing AWS CLI..."
              sudo apt-get update
              sudo apt-get install -y unzip curl
              curl "https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip" -o "awscliv2.zip"
              unzip -q awscliv2.zip
              sudo ./aws/install
              rm -rf awscliv2.zip aws/
              echo "âœ… AWS CLI installed"
            else
              echo "âœ… AWS CLI already installed: $(aws --version)"
            fi

            # â”€â”€ Ensure Docker is running â”€â”€
            sudo systemctl start docker 2>/dev/null || true

            # â”€â”€ Verify everything works â”€â”€
            echo ""
            echo "=== EC2 Prerequisite Check ==="
            echo "Docker: $(docker --version 2>/dev/null || echo 'NOT FOUND')"
            echo "AWS CLI: $(aws --version 2>/dev/null || echo 'NOT FOUND')"
            echo "User groups: $(groups)"
            echo "âœ… EC2 is ready for deployment"

      # â”€â”€ Deploy to EC2 via SSH â”€â”€
      - name: Deploy to EC2
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          envs: AWS_ACCESS_KEY_ID,AWS_SECRET_ACCESS_KEY,AWS_DEFAULT_REGION
          script: |
            set -e

            # Use sudo docker if user not yet in docker group (first run)
            DOCKER_CMD="docker"
            if ! docker info &> /dev/null 2>&1; then
              DOCKER_CMD="sudo docker"
              echo "âš ï¸ Using sudo for docker (first run â€” re-login later for non-sudo access)"
            fi

            # â”€â”€ Configure AWS CLI inline â”€â”€
            export AWS_ACCESS_KEY_ID="${{ secrets.AWS_ACCESS_KEY_ID }}"
            export AWS_SECRET_ACCESS_KEY="${{ secrets.AWS_SECRET_ACCESS_KEY }}"
            export AWS_DEFAULT_REGION="${{ secrets.AWS_REGION }}"

            # â”€â”€ Login to ECR â”€â”€
            echo "ðŸ”‘ Logging into ECR..."
            aws ecr get-login-password --region ${{ secrets.AWS_REGION }} | \
              $DOCKER_CMD login --username AWS --password-stdin ${{ secrets.AWS_ACCOUNT_ID }}.dkr.ecr.${{ secrets.AWS_REGION }}.amazonaws.com

            # â”€â”€ Pull latest image â”€â”€
            IMAGE="${{ secrets.AWS_ACCOUNT_ID }}.dkr.ecr.${{ secrets.AWS_REGION }}.amazonaws.com/${{ secrets.ECR_REPOSITORY }}:${{ github.sha }}"
            echo "ðŸ“¥ Pulling image: $IMAGE"
            $DOCKER_CMD pull "$IMAGE"

            # â”€â”€ Stop old container â”€â”€
            echo "ðŸ›‘ Stopping old container..."
            $DOCKER_CMD stop devsecops-chatbot 2>/dev/null || true
            $DOCKER_CMD rm devsecops-chatbot 2>/dev/null || true

            # â”€â”€ Run new container â”€â”€
            echo "ðŸš€ Starting new container..."
            $DOCKER_CMD run -d \
              --name devsecops-chatbot \
              --restart unless-stopped \
              -p 8501:8501 \
              -e GROQ_API_KEY="${{ secrets.GROQ_API_KEY }}" \
              -e GH_PAT_TOKEN="${{ secrets.GH_PAT_TOKEN }}" \
              "$IMAGE"

            # â”€â”€ Verify it's running â”€â”€
            sleep 5
            if $DOCKER_CMD ps | grep -q devsecops-chatbot; then
              echo ""
              echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
              echo "âœ… Chatbot deployed successfully!"
              echo "ðŸŒ Access at http://${{ secrets.EC2_HOST }}:8501"
              echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            else
              echo "âŒ Container failed to start"
              $DOCKER_CMD logs devsecops-chatbot
              exit 1
            fi

            # â”€â”€ Cleanup old images â”€â”€
            $DOCKER_CMD image prune -af --filter "until=24h" 2>/dev/null || true

      - name: Deployment summary
        run: |
          echo "## ðŸš€ Deployment Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Detail | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| **Image** | \`${{ secrets.ECR_REPOSITORY }}:${{ github.sha }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **Host** | \`${{ secrets.EC2_HOST }}:8501\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **Commit** | \`${{ github.sha }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **Branch** | \`${{ github.ref_name }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸŒ **Chatbot URL:** http://${{ secrets.EC2_HOST }}:8501" >> $GITHUB_STEP_SUMMARY
