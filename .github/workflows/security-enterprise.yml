name: "Enterprise Security Pipeline (AI-Driven)"

on:
  push:
    branches:
      - feature/AgentAI
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write
  security-events: write

env:
  REPORTS_DIR: reports
  OUTPUT_DIR: agent_output
  AUDIT_DIR: security-review
  APP_DIR: Order-app-main
  PYTHON_VERSION: 3.12
  LLM_MODEL: "qwen2.5-coder:3b"
  OLLAMA_URL: "http://localhost:11434"
  OLLAMA_NUM_CTX: 4096
  OLLAMA_NUM_PREDICT: 1024
  OLLAMA_TEMP: 0.1
  MIN_SEVERITY: low

# ------------------------------------------------------------
# JOB 1: SECURITY SCAN
# ------------------------------------------------------------
jobs:
  security-scan:
    name: "üîç Security Scan"
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repo
        uses: actions/checkout@v4

      - name: Create reports directory
        run: mkdir -p "${REPORTS_DIR}"

      # -------------------------
      # Semgrep (CLI version)
      # -------------------------
      - name: Install Semgrep
        run: python3 -m pip install semgrep

      - name: Run Semgrep JSON scan
        run: |
          semgrep --config=auto --json > "${REPORTS_DIR}/semgrep.json" || echo '{}' > "${REPORTS_DIR}/semgrep.json"

      - name: Run Semgrep SARIF scan
        run: |
          semgrep --config=auto --sarif > "${REPORTS_DIR}/semgrep.sarif" || echo '{}' > "${REPORTS_DIR}/semgrep.sarif"

      # -------------------------
      # Trivy FS
      # -------------------------
      - name: Install Trivy
        run: |
          curl -sfL https://raw.githubusercontent.com/aquasecurity/trivy/main/contrib/install.sh \
          | sh -s -- -b /usr/local/bin
          trivy --version

      - name: Run Trivy FS Scan
        run: |
          trivy fs --format json --output "${REPORTS_DIR}/trivy_fs.json" "${APP_DIR}" \
          || echo '{}' > "${REPORTS_DIR}/trivy_fs.json"

      # -------------------------
      # Trivy Image (conditional)
      # -------------------------
      - name: Run Trivy Image Scan
        run: |
          if [ -f "${APP_DIR}/Dockerfile" ]; then
            docker build -t app-scan "${APP_DIR}"
            trivy image --format json --output "${REPORTS_DIR}/trivy_image.json" app-scan \
            || echo '{}' > "${REPORTS_DIR}/trivy_image.json"
          else
            echo '{}' > "${REPORTS_DIR}/trivy_image.json"
          fi

      # -------------------------
      # Gitleaks
      # -------------------------
      - name: Install Gitleaks
        run: |
          sudo apt-get update
          sudo apt-get install -y jq curl
          VERSION=$(curl -s https://api.github.com/repos/gitleaks/gitleaks/releases/latest | jq -r .tag_name)
          curl -sL "https://github.com/gitleaks/gitleaks/releases/download/${VERSION}/gitleaks_${VERSION#v}_linux_x64.tar.gz" \
            | tar -xz
          sudo mv gitleaks /usr/local/bin/

      - name: Run Gitleaks
        run: |
          gitleaks detect --source . --no-git --report-format json \
            --report-path "${REPORTS_DIR}/gitleaks.json" \
          || echo '[]' > "${REPORTS_DIR}/gitleaks.json"

      # -------------------------
      # Conftest (error-tolerant)
      # -------------------------
      - name: Install Conftest
        run: |
          VERSION=$(curl -s https://api.github.com/repos/open-policy-agent/conftest/releases/latest | jq -r .tag_name)
          curl -sL "https://github.com/open-policy-agent/conftest/releases/download/${VERSION}/conftest_${VERSION#v}_Linux_x86_64.tar.gz" \
            | tar -xz
          sudo mv conftest /usr/local/bin/

      - name: Run Conftest
        run: |
          conftest test k8s terraform policy --output json > "${REPORTS_DIR}/conftest.json" \
          || echo '[]' > "${REPORTS_DIR}/conftest.json"

      # -------------------------
      # Diagnostics
      # -------------------------
      - name: Show Reports
        run: |
          echo "Reports generated:"
          ls -la reports/

      - name: Upload scan reports
        uses: actions/upload-artifact@v4
        with:
          name: scan-reports
          path: reports/
          retention-days: 7


# ------------------------------------------------------------
# JOB 2: AI ANALYSIS (NO PATCHING)
# ------------------------------------------------------------
  ai-analysis:
    name: "ü§ñ AI Analysis"
    runs-on: ubuntu-latest
    needs: security-scan

    steps:
      - name: Checkout Repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Download Scan Reports
        uses: actions/download-artifact@v4
        with:
          name: scan-reports
          path: reports/

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install Python Dependencies
        run: pip install pyyaml requests

      # --------------------------------------------------
      # Install Ollama + Pull Qwen model
      # --------------------------------------------------
      - name: Install Ollama
        run: |
          curl -fsSL https://ollama.com/install.sh | sh
          nohup ollama serve > /tmp/ollama.log 2>&1 &
          sleep 5

      - name: Pull Qwen Model
        run: |
          ollama pull "${LLM_MODEL}"

      # --------------------------------------------------
      # AI Analysis (NO FIXES)
      # --------------------------------------------------
      - name: Run AI Security Analysis
        run: |
          mkdir -p "${OUTPUT_DIR}"
          python main.py --analysis-only --model "${LLM_MODEL}"

      - name: Persist Analysis Output
        run: |
          RUN_ID=${GITHUB_RUN_ID}
          mkdir -p "${AUDIT_DIR}/run-${RUN_ID}"
          cp -r agent_output/* "${AUDIT_DIR}/run-${RUN_ID}/"

      - name: Upload Analysis Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ai-analysis-output
          path: agent_output/


# ------------------------------------------------------------
# JOB 3: AI FIX GENERATION
# ------------------------------------------------------------
  ai-fix-generation:
    name: "üîß AI Fix Generation"
    runs-on: ubuntu-latest
    needs: ai-analysis

    steps:
      - name: Checkout Repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Download Analysis Output
        uses: actions/download-artifact@v4
        with:
          name: ai-analysis-output
          path: agent_output/

      - name: Install Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install Dependencies
        run: pip install requests pyyaml

      # Install Ollama for fix generation
      - name: Install Ollama
        run: |
          curl -fsSL https://ollama.com/install.sh | sh
          nohup ollama serve > /tmp/ollama.log 2>&1 &
          sleep 5

      - name: Pull Qwen Model
        run: ollama pull "${LLM_MODEL}"

      # --------------------------------------------------
      # Generate Fixes into patches/ folder
      # --------------------------------------------------
      - name: AI Generate Fix Patches
        run: |
          mkdir -p agent_output/patches
          python main.py --generate-fixes --model "${LLM_MODEL}"

      # --------------------------------------------------
      # Create Remediation Branch
      # --------------------------------------------------
      - name: Create Branch + Apply Patches
        run: |
          RUN_ID=${GITHUB_RUN_ID}
          FIX_BRANCH="security/fix-run-${RUN_ID}"

          git checkout -b "${FIX_BRANCH}"

          if compgen -G "agent_output/patches/*.patch" > /dev/null; then
            git apply agent_output/patches/*.patch || true
          fi

          git add .
          git commit -m "AI Security Fixes (Run ${RUN_ID})" || true

      # --------------------------------------------------
      # Open Pull Request
      # --------------------------------------------------
      - name: Open Pull Request to feature/AgentAI
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          branch: "security/fix-run-${{ github.run_id }}"
          base: "feature/AgentAI"
          title: "üîí AI Security Fixes (Run ${{ github.run_id }})"
          body: |
            ## üîí AI Security Fixes Generated

            - Model: qwen2.5-coder:3b  
            - Analysis + Fixes separated  
            - Patches generated safely under `agent_output/patches/`  
            - Full audit available under `security-review/run-${{ github.run_id }}/`  

            **Please review before merging.**

          add-paths: |
            security-review/**
            agent_output/**
            reports/**


# ------------------------------------------------------------
# JOB 4: SECURITY GATE
# ------------------------------------------------------------
  security-gate:
    name: "üö¶ Security Gate"
    runs-on: ubuntu-latest
    needs: ai-fix-generation

    steps:
      - name: Download AI Output
        uses: actions/download-artifact@v4
        with:
          name: ai-analysis-output
          path: agent_output/

      - name: Evaluate Security Decision
        run: |
          STATUS="pass"
          if [ -f agent_output/decision.json ]; then
            STATUS=$(jq -r '.status' agent_output/decision.json)
          fi

          echo "Final status: $STATUS"

          if [ "$STATUS" != "pass" ]; then
            echo "‚ùå Security gate FAILED ‚Äî Review PR"
            exit 1
          fi

          echo "‚úÖ Security gate PASSED"