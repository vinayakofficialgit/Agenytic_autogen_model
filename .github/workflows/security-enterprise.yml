name: "Enterprise Security Pipeline (AI-Driven)"

on:
  push:
    branches:
      - feature/AgentAI
  workflow_dispatch:

concurrency:
  group: security-enterprise-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: write
  pull-requests: write
  security-events: write

env:
  REPORTS_DIR: reports
  OUTPUT_DIR: agent_output
  APP_DIR: Order-app-main
  PYTHON_VERSION: 3.12

  LLM_MODEL: "qwen2.5-coder:3b"
  OLLAMA_HOST: "127.0.0.1:11434"

  MIN_SEVERITY: low

  TRIVY_CACHE_DIR: ~/.cache/trivy
  TRIVY_VERSION: "0.55.2"

jobs:

# ============================================================
# 1Ô∏è‚É£ SECURITY SCAN
# ============================================================

  security-scan:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: pip

      - run: mkdir -p "${REPORTS_DIR}"

      - run: |
          sudo apt-get update
          sudo apt-get install -y jq curl

      - run: python -m pip install --upgrade pip semgrep

      - name: Run Semgrep JSON
        run: |
          semgrep --config=auto --json . > "${REPORTS_DIR}/semgrep.json" \
          || echo '{}' > "${REPORTS_DIR}/semgrep.json"

      - uses: actions/cache@v4
        with:
          path: ${{ env.TRIVY_CACHE_DIR }}
          key: trivy-db-${{ runner.os }}-${{ env.TRIVY_VERSION }}

      - name: Install Trivy
        run: |
          curl -sfL https://raw.githubusercontent.com/aquasecurity/trivy/main/contrib/install.sh \
          | sh -s -- -b /usr/local/bin "v${TRIVY_VERSION}"

      - name: Run Trivy FS
        run: |
          trivy fs --cache-dir "${TRIVY_CACHE_DIR}" --format json \
            --output "${REPORTS_DIR}/trivy_fs.json" "${APP_DIR}" \
          || echo '{}' > "${REPORTS_DIR}/trivy_fs.json"

      - uses: actions/upload-artifact@v4
        with:
          name: scan-reports
          path: reports/

# ============================================================
# 2Ô∏è‚É£ AI ANALYSIS
# ============================================================

  ai-analysis:
    runs-on: ubuntu-latest
    needs: security-scan

    outputs:
      security_status: ${{ steps.decision.outputs.security_status }}

    steps:
      - uses: actions/checkout@v4

      - uses: actions/download-artifact@v4
        with:
          name: scan-reports
          path: reports/

      - uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: pip

      - run: pip install -U pyyaml requests

      - name: Run AI Analysis (Never fail job here)
        run: |
          mkdir -p "${OUTPUT_DIR}"
          export CI_MODE=1
          python main.py --analysis-only

      - name: Extract Decision
        id: decision
        run: |
          STATUS="pass"
          if [ -f agent_output/decision.json ]; then
            STATUS=$(jq -r '.status' agent_output/decision.json)
          fi
          echo "security_status=$STATUS" >> $GITHUB_OUTPUT

      - uses: actions/upload-artifact@v4
        with:
          name: ai-analysis-output
          path: agent_output/

# ============================================================
# 3Ô∏è‚É£ AI FIX GENERATION
# ============================================================

  ai-fix-generation:
    runs-on: ubuntu-latest
    needs: ai-analysis
    if: needs.ai-analysis.outputs.security_status == 'fail'

    steps:
      - uses: actions/checkout@v4

      - uses: actions/download-artifact@v4
        with:
          name: scan-reports
          path: reports/

      - uses: actions/download-artifact@v4
        with:
          name: ai-analysis-output
          path: agent_output/

      - uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - run: pip install -U requests pyyaml

      - name: Generate Fixes
        run: |
          mkdir -p agent_output/patches
          python main.py --generate-fixes --skip-llm || true

      # ------------------------------
      # SAFE PATCH VALIDATION
      # ------------------------------

      - name: Validate Patch Integrity
        run: |
          shopt -s nullglob
          patches=(agent_output/patches/*.patch)

          if [ ${#patches[@]} -eq 0 ]; then
            echo "No patches generated."
            exit 0
          fi

          for p in "${patches[@]}"; do
            echo "Checking patch: $p"
            git apply --check "$p"
          done

      - name: Apply Patches
        run: |
          shopt -s nullglob
          patches=(agent_output/patches/*.patch)

          if [ ${#patches[@]} -eq 0 ]; then
            echo "No patches to apply."
            exit 0
          fi

          for p in "${patches[@]}"; do
            echo "Applying patch: $p"
            git apply --3way --whitespace=nowarn "$p"
          done

          git add -A
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git commit -m "AI Security Fixes" || true

      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          branch: "security/fix-run-${{ github.run_id }}"
          base: "feature/AgentAI"
          title: "üîí AI Security Fixes (Run ${{ github.run_id }})"
          body: |
            Automated AI-generated security remediations.

# ============================================================
# 4Ô∏è‚É£ SECURITY GATE
# ============================================================

  security-gate:
    runs-on: ubuntu-latest
    needs: ai-analysis

    steps:
      - name: Enforce Gate
        run: |
          if [ "${{ needs.ai-analysis.outputs.security_status }}" != "pass" ]; then
            echo "‚ùå Security gate FAILED ‚Äî Vulnerabilities detected"
            exit 1
          fi
          echo "‚úÖ Security gate PASSED"