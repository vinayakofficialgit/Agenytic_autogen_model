name: "Enterprise Security Pipeline (AI-Driven)"

on:
  push:
    branches:
      - feature/AgentAI
  workflow_dispatch:

concurrency:
  group: security-enterprise-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: write
  pull-requests: write
  security-events: write

env:
  REPORTS_DIR: reports
  OUTPUT_DIR: agent_output
  APP_DIR: Order-app-main
  PYTHON_VERSION: 3.12
  LLM_MODEL: "qwen2.5-coder:3b"
  OLLAMA_HOST: "127.0.0.1:11434"
  MIN_SEVERITY: low

jobs:

# ==========================================================
# 1Ô∏è‚É£ SECURITY SCAN
# ==========================================================

  security-scan:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - run: mkdir -p reports

      - run: |
          sudo apt-get update
          sudo apt-get install -y jq curl

      - run: python -m pip install --upgrade pip semgrep

      - name: Run Semgrep
        run: |
          semgrep --config=auto --json . > reports/semgrep.json || echo '{}' > reports/semgrep.json

      - name: Install Trivy
        run: |
          curl -sfL https://raw.githubusercontent.com/aquasecurity/trivy/main/contrib/install.sh \
          | sh -s -- -b /usr/local/bin

      - name: Run Trivy
        run: |
          trivy fs --format json --output reports/trivy_fs.json "${APP_DIR}" \
          || echo '{}' > reports/trivy_fs.json

      - uses: actions/upload-artifact@v4
        with:
          name: scan-reports
          path: reports/

# ==========================================================
# 2Ô∏è‚É£ AI ANALYSIS (NEVER FAILS)
# ==========================================================

  ai-analysis:
    runs-on: ubuntu-latest
    needs: security-scan

    outputs:
      security_status: ${{ steps.decision.outputs.security_status }}

    steps:
      - uses: actions/checkout@v4

      - uses: actions/download-artifact@v4
        with:
          name: scan-reports
          path: reports/

      - uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - run: pip install -U pyyaml requests

      - name: Install Ollama
        run: |
          curl -fsSL https://ollama.com/install.sh | sh
          nohup ollama serve > /tmp/ollama.log 2>&1 &
          sleep 5
          ollama pull "${LLM_MODEL}"

      - name: Run AI Analysis (Never Fail Job)
        run: |
          mkdir -p agent_output
          set +e
          python main.py --analysis-only
          EXIT_CODE=$?
          echo "Pipeline exit code: $EXIT_CODE"
          set -e

      - name: Show Decision
        run: cat agent_output/decision.json || echo "No decision file"

      - name: Extract Decision Status
        id: decision
        run: |
          STATUS="pass"
          if [ -f agent_output/decision.json ]; then
            STATUS=$(jq -r '.status' agent_output/decision.json)
          fi
          echo "security_status=$STATUS" >> $GITHUB_OUTPUT

      - uses: actions/upload-artifact@v4
        with:
          name: ai-analysis-output
          path: agent_output/

# ==========================================================
# 3Ô∏è‚É£ AI FIX GENERATION (ONLY IF FAIL)
# ==========================================================

  ai-fix-generation:
    runs-on: ubuntu-latest
    needs: ai-analysis
    if: needs.ai-analysis.outputs.security_status == 'fail'

    steps:
      - uses: actions/checkout@v4

      - uses: actions/download-artifact@v4
        with:
          name: scan-reports
          path: reports/

      - uses: actions/download-artifact@v4
        with:
          name: ai-analysis-output
          path: agent_output/

      - uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - run: pip install -U pyyaml requests

      - name: Generate Fixes
        run: |
          mkdir -p agent_output/patches
          python main.py --generate-fixes --skip-llm || true

      - name: Validate Patches
        run: |
          for p in agent_output/patches/*.patch; do
            git apply --check "$p"
          done

      - name: Apply Patches
        run: |
          for p in agent_output/patches/*.patch; do
            git apply --3way --whitespace=nowarn "$p"
          done
          git add -A
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git commit -m "AI Security Fixes" || true

      - name: Create PR
        uses: peter-evans/create-pull-request@v6
        with:
          branch: security/fix-${{ github.run_id }}
          base: feature/AgentAI
          title: "üîí AI Security Fixes"
          body: "Automated security remediation PR"

# ==========================================================
# 4Ô∏è‚É£ SECURITY GATE (ONLY FAIL HERE)
# ==========================================================

  security-gate:
    runs-on: ubuntu-latest
    needs: ai-analysis

    steps:
      - name: Enforce Gate
        run: |
          if [ "${{ needs.ai-analysis.outputs.security_status }}" != "pass" ]; then
            echo "‚ùå Security gate FAILED ‚Äî Vulnerabilities detected"
            exit 1
          fi
          echo "‚úÖ Security gate PASSED"