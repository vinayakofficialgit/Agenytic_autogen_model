name: "Enterprise Security Pipeline (AI-Driven)"

on:
  push:
    branches:
      - feature/AgentAI
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write
  security-events: write

env:
  REPORTS_DIR: reports
  OUTPUT_DIR: agent_output
  AUDIT_DIR: security-review
  APP_DIR: Order-app-main
  PYTHON_VERSION: 3.12
  LLM_MODEL: "qwen2.5-coder:3b"
  # Normalize Ollama networking for CI
  OLLAMA_URL: "http://127.0.0.1:11434"
  OLLAMA_HOST: "127.0.0.1:11434"
  OLLAMA_NUM_CTX: 4096
  OLLAMA_NUM_PREDICT: 1024
  OLLAMA_TEMP: 0.1
  MIN_SEVERITY: low

# ------------------------------------------------------------
# JOB 1: SECURITY SCAN
# ------------------------------------------------------------
jobs:
  security-scan:
    name: "üîç Security Scan"
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repo
        uses: actions/checkout@v4

      - name: Create reports directory
        run: mkdir -p "${REPORTS_DIR}"

      # -------------------------
      # Semgrep (CLI version)
      # -------------------------
      - name: Install Semgrep
        run: python3 -m pip install semgrep

      - name: Run Semgrep JSON scan
        run: |
          semgrep --config=auto --json > "${REPORTS_DIR}/semgrep.json" || echo '{}' > "${REPORTS_DIR}/semgrep.json"

      - name: Run Semgrep SARIF scan
        run: |
          semgrep --config=auto --sarif > "${REPORTS_DIR}/semgrep.sarif" || echo '{}' > "${REPORTS_DIR}/semgrep.sarif"

      # -------------------------
      # Trivy FS
      # -------------------------
      - name: Install Trivy
        run: |
          curl -sfL https://raw.githubusercontent.com/aquasecurity/trivy/main/contrib/install.sh \
          | sh -s -- -b /usr/local/bin
          trivy --version

      - name: Run Trivy FS Scan
        run: |
          trivy fs --format json --output "${REPORTS_DIR}/trivy_fs.json" "${APP_DIR}" \
          || echo '{}' > "${REPORTS_DIR}/trivy_fs.json"

      # -------------------------
      # Trivy Image (conditional)
      # -------------------------
      - name: Run Trivy Image Scan
        run: |
          if [ -f "${APP_DIR}/Dockerfile" ]; then
            docker build -t app-scan "${APP_DIR}"
            trivy image --format json --output "${REPORTS_DIR}/trivy_image.json" app-scan \
            || echo '{}' > "${REPORTS_DIR}/trivy_image.json"
          else
            echo '{}' > "${REPORTS_DIR}/trivy_image.json"
          fi

      # -------------------------
      # Gitleaks
      # -------------------------
      - name: Install Gitleaks
        run: |
          sudo apt-get update
          sudo apt-get install -y jq curl
          VERSION=$(curl -s https://api.github.com/repos/gitleaks/gitleaks/releases/latest | jq -r .tag_name)
          curl -sL "https://github.com/gitleaks/gitleaks/releases/download/${VERSION}/gitleaks_${VERSION#v}_linux_x64.tar.gz" \
            | tar -xz
          sudo mv gitleaks /usr/local/bin/

      - name: Run Gitleaks
        run: |
          gitleaks detect --source . --no-git --report-format json \
            --report-path "${REPORTS_DIR}/gitleaks.json" \
          || echo '[]' > "${REPORTS_DIR}/gitleaks.json"

      # -------------------------
      # Conftest (guarded)
      # -------------------------
      - name: Install Conftest
        run: |
          VERSION=$(curl -s https://api.github.com/repos/open-policy-agent/conftest/releases/latest | jq -r .tag_name)
          curl -sL "https://github.com/open-policy-agent/conftest/releases/download/${VERSION}/conftest_${VERSION#v}_Linux_x86_64.tar.gz" \
            | tar -xz
          sudo mv conftest /usr/local/bin/

      - name: Run Conftest (only if policy dirs exist)
        run: |
          targets=""
          for d in k8s terraform policy; do
            [ -d "$d" ] && targets="$targets $d"
          done
          if [ -n "$targets" ]; then
            conftest test $targets --output json > "${REPORTS_DIR}/conftest.json" || echo '[]' > "${REPORTS_DIR}/conftest.json"
          else
            echo '[]' > "${REPORTS_DIR}/conftest.json"
          fi

      # -------------------------
      # Diagnostics + Publishing
      # -------------------------
      - name: Show Reports
        run: |
          echo "Reports generated:"
          ls -la reports/

      # (G) Publish SARIF to GitHub Code Scanning
      - name: Upload Semgrep SARIF to Code Scanning
        uses: github/codeql-action/upload-sarif@v4
        with:
          sarif_file: reports/semgrep.sarif

      - name: Upload scan reports
        uses: actions/upload-artifact@v4
        with:
          name: scan-reports
          path: reports/
          retention-days: 7


  # ------------------------------------------------------------
  # JOB 2: AI ANALYSIS (NO PATCHING)
  # ------------------------------------------------------------
  ai-analysis:
    name: "ü§ñ AI Analysis"
    runs-on: ubuntu-latest
    needs: security-scan

    steps:
      - name: Checkout Repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Download Scan Reports
        uses: actions/download-artifact@v4
        with:
          name: scan-reports
          path: reports/

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install Python Dependencies
        run: pip install pyyaml requests

      # --------------------------------------------------
      # Install Ollama + Pull Qwen model (with health wait)
      # --------------------------------------------------
      - name: Install Ollama
        run: |
          curl -fsSL https://ollama.com/install.sh | sh
          nohup ollama serve > /tmp/ollama.log 2>&1 &
          for i in {1..30}; do
            curl -sSf http://${{ env.OLLAMA_HOST }}/api/tags && break || sleep 2
          done

      - name: Pull Qwen Model
        run: ollama pull "${LLM_MODEL}"

      # --------------------------------------------------
      # AI Analysis (deterministic, no fixes)
      # --------------------------------------------------
      - name: Run AI Security Analysis
        continue-on-error: true
        run: |
          mkdir -p "${OUTPUT_DIR}"
          python main.py --analysis-only --model "${LLM_MODEL}" --ollama-url "${{ env.OLLAMA_URL }}" --verbose || true

      - name: Persist Analysis Output
        run: |
          RUN_ID=${GITHUB_RUN_ID}
          mkdir -p "${AUDIT_DIR}/run-${RUN_ID}"
          cp -r agent_output/* "${AUDIT_DIR}/run-${RUN_ID}/" || true

      - name: Upload Analysis Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ai-analysis-output
          path: agent_output/

      # (D) Upload the audit folder (to pull into PR later)
      - name: Upload Audit (security-review)
        uses: actions/upload-artifact@v4
        with:
          name: security-review
          path: security-review/


  # ------------------------------------------------------------
  # JOB 3: AI FIX GENERATION
  # ------------------------------------------------------------
  ai-fix-generation:
    name: "üîß AI Fix Generation"
    runs-on: ubuntu-latest
    needs: ai-analysis

    steps:
      - name: Checkout Repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Download Analysis Output
        uses: actions/download-artifact@v4
        with:
          name: ai-analysis-output
          path: agent_output/

      #  Bring audit dir into workspace before PR
      - name: Download Audit
        uses: actions/download-artifact@v4
        with:
          name: security-review
          path: security-review/

      # Bring scan reports into workspace so reports/** exists
      - name: Download Scan Reports
        uses: actions/download-artifact@v4
        with:
          name: scan-reports
          path: reports/    

      - name: Install Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install Dependencies
        run: pip install requests pyyaml

      # Install Ollama for fix generation (with health wait)
      - name: Install Ollama
        run: |
          curl -fsSL https://ollama.com/install.sh | sh
          nohup ollama serve > /tmp/ollama.log 2>&1 &
          for i in {1..30}; do
            curl -sSf http://${{ env.OLLAMA_HOST }}/api/tags && break || sleep 2
          done

      - name: Pull Qwen Model
        run: ollama pull "${LLM_MODEL}"

      # --------------------------------------------------
      # Generate Fixes into patches/ folder; do not fail job if policy FAIL
      # --------------------------------------------------
      - name: AI Generate Fix Patches
        run: |
          mkdir -p agent_output/patches
          python main.py --generate-fixes --model "${LLM_MODEL}" --ollama-url "${{ env.OLLAMA_URL }}" --verbose || true

      
      #------------------------------------------------------------
      # one‚Äëshot diagnostic step to print the first 20 lines of every patch
      #------------------------------------------------------------
      - name: Inspect generated patches (first 20 lines)
        if: ${{ hashFiles('agent_output/patches/*.patch') != '' }}
        run: |
          for p in agent_output/patches/*.patch; do
            echo "---- $p (head) ----"
            sed -n '1,20p' "$p"
            echo
          done

      #------------------------------------------------------------
      # Author Identity for Commits
      #------------------------------------------------------------
      - name: Configure Git Identity
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"  
      
      # Tiny Normalization (LF endings):
      
      - name: Normalize patch line-endings (LF)
        if: ${{ hashFiles('agent_output/patches/*.patch') != '' }}
        run: |
          sed -i 's/\r$//' agent_output/patches/*.patch || true
	  
      # ------------------------------------------------------------
      # APPLY PATCHES SAFELY (inserted here)
      # ------------------------------------------------------------
      
      - name: Apply Patches (safely)
        run: |
          set -e
          if compgen -G "agent_output/patches/*.patch" > /dev/null; then
            for p in agent_output/patches/*.patch; do
              echo ">>> Checking $p"
      
              # Try exact apply first, then 3-way merge, then reject fallback
              git apply --check "$p" \
                || git apply --3way --whitespace=nowarn "$p" \
                || git apply --reject --whitespace=nowarn "$p" \
                || true
            done
      
            # Show .rej files if any were generated
            if compgen -G "*.rej" > /dev/null; then
              echo "Patch rejects found:"
              find . -name "*.rej" -print
            fi
      
            git add -A
            if ! git diff --cached --quiet; then
              git commit -m "AI Security Fixes (Patches)"
            else
              echo "No staged changes after applying patches."
            fi
          else
            echo "No patches found."
          fi

      # Let the action manage branch + commit entirely using add-paths

      # --------------------------------------------------
      # Open Pull Request
      # --------------------------------------------------
      - name: Open Pull Request to feature/AgentAI
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          branch: "security/fix-run-${{ github.run_id }}"
          base: "feature/AgentAI"
          title: "üîí AI Security Fixes (Run ${{ github.run_id }})"
          body: |
            ## üîí AI Security Fixes Generated

            - Model: ${{ env.LLM_MODEL }}
            - Patches (if any) under `agent_output/patches/`
            - Full audit under `security-review/run-${{ github.run_id }}/`
            - Raw reports in `reports/`

            **Please review before merging.**
          add-paths: |
            security-review/**
            agent_output/**
            reports/**
          # reset-branch: false
          # reset-branch-on-update: false

  
  # ------------------------------------------------------------
  # JOB 4: SECURITY GATE
  # ------------------------------------------------------------
  security-gate:
    name: "üö¶ Security Gate"
    runs-on: ubuntu-latest
    needs: ai-fix-generation

    steps:
      - name: Download AI Output
        uses: actions/download-artifact@v4
        with:
          name: ai-analysis-output
          path: agent_output/

      - name: Install jq
        run: |
          sudo apt-get update
          sudo apt-get install -y jq

      - name: Evaluate Security Decision
        run: |
          STATUS="pass"
          if [ -f agent_output/decision.json ]; then
            STATUS=$(jq -r '.status' agent_output/decision.json)
          fi
          echo "Final status: $STATUS"

          if [ "$STATUS" != "pass" ]; then
            echo "‚ùå Security gate FAILED ‚Äî Review PR"
            exit 1
          fi

          echo "‚úÖ Security gate PASSED"