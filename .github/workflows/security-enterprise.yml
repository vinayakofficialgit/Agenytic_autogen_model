name: "Enterprise Security Pipeline (AI-Driven)"

on:
  push:
    branches:
      - feature/AgentAI
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write
  security-events: write

env:
  REPORTS_DIR: reports
  OUTPUT_DIR: agent_output
  AUDIT_DIR: security-review
  APP_DIR: Order-app-main
  PYTHON_VERSION: 3.12
  LLM_MODEL: "qwen2.5-coder:3b"
  OLLAMA_URL: "http://127.0.0.1:11434"
  OLLAMA_HOST: "127.0.0.1:11434"
  OLLAMA_NUM_CTX: 4096
  OLLAMA_NUM_PREDICT: 1024
  OLLAMA_TEMP: 0.1
  MIN_SEVERITY: low
  TRIVY_CACHE_DIR: ~/.cache/trivy

jobs:
  security-scan:
    name: "üîç Security Scan"
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repo
        uses: actions/checkout@v4

      - name: Setup Python (pip cache)
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: "pip"
          cache-dependency-path: |
            requirements.txt

      - name: Cache Semgrep
        uses: actions/cache@v4
        with:
          path: ~/.semgrep
          key: semgrep-${{ runner.os }}-${{ env.PYTHON_VERSION }}-${{ hashFiles('requirements.txt') }}
          restore-keys: |
            semgrep-${{ runner.os }}-${{ env.PYTHON_VERSION }}-

      - name: Cache Trivy DB
        uses: actions/cache@v4
        with:
          path: ${{ env.TRIVY_CACHE_DIR }}
          key: trivy-${{ runner.os }}-${{ hashFiles(format('{0}/package-lock.json', env.APP_DIR)) }}
          restore-keys: |
            trivy-${{ runner.os }}-

      - name: Create reports directory
        run: mkdir -p "${REPORTS_DIR}"

      - name: Install baseline tools
        run: |
          sudo apt-get update
          sudo apt-get install -y jq curl

      # Semgrep
      - name: Install Semgrep
        run: python -m pip install -U semgrep

      - name: Run Semgrep JSON scan
        run: |
          semgrep --config=auto --json > "${REPORTS_DIR}/semgrep.json" || echo '{}' > "${REPORTS_DIR}/semgrep.json"

      - name: Run Semgrep SARIF scan
        run: |
          semgrep --config=auto --sarif > "${REPORTS_DIR}/semgrep.sarif" || echo '{}' > "${REPORTS_DIR}/semgrep.sarif"

      # Trivy
      - name: Install Trivy
        run: |
          curl -sfL https://raw.githubusercontent.com/aquasecurity/trivy/main/contrib/install.sh \
          | sh -s -- -b /usr/local/bin
          trivy --version

      - name: Run Trivy FS Scan
        run: |
          trivy fs --cache-dir "${TRIVY_CACHE_DIR}" --format json --output "${REPORTS_DIR}/trivy_fs.json" "${APP_DIR}" \
          || echo '{}' > "${REPORTS_DIR}/trivy_fs.json"

      - name: Run Trivy Image Scan
        run: |
          if [ -f "${APP_DIR}/Dockerfile" ]; then
            docker build -t app-scan "${APP_DIR}"
            trivy image --cache-dir "${TRIVY_CACHE_DIR}" --format json --output "${REPORTS_DIR}/trivy_image.json" app-scan \
            || echo '{}' > "${REPORTS_DIR}/trivy_image.json"
          else
            echo '{}' > "${REPORTS_DIR}/trivy_image.json"
          fi

      # Gitleaks
      - name: Install Gitleaks
        run: |
          VERSION=$(curl -s https://api.github.com/repos/gitleaks/gitleaks/releases/latest | jq -r .tag_name)
          curl -sL "https://github.com/gitleaks/gitleaks/releases/download/${VERSION}/gitleaks_${VERSION#v}_linux_x64.tar.gz" | tar -xz
          sudo mv gitleaks /usr/local/bin/

      - name: Run Gitleaks
        run: |
          gitleaks detect --source . --no-git --report-format json \
            --report-path "${REPORTS_DIR}/gitleaks.json" \
          || echo '[]' > "${REPORTS_DIR}/gitleaks.json"

      # Conftest
      - name: Install Conftest
        run: |
          VERSION=$(curl -s https://api.github.com/repos/open-policy-agent/conftest/releases/latest | jq -r .tag_name)
          curl -sL "https://github.com/open-policy-agent/conftest/releases/download/${VERSION}/conftest_${VERSION#v}_Linux_x86_64.tar.gz" | tar -xz
          sudo mv conftest /usr/local/bin/

      - name: Run Conftest (only if policy dirs exist)
        run: |
          targets=""
          for d in k8s terraform policy; do
            [ -d "$d" ] && targets="$targets $d"
          done
          if [ -n "$targets" ]; then
            conftest test $targets --output json > "${REPORTS_DIR}/conftest.json" || echo '[]' > "${REPORTS_DIR}/conftest.json"
          else
            echo '[]' > "${REPORTS_DIR}/conftest.json"
          fi

      - name: Show Reports
        run: |
          echo "Reports generated:"
          ls -la reports/

      - name: Upload Semgrep SARIF to Code Scanning
        uses: github/codeql-action/upload-sarif@v4
        with:
          sarif_file: reports/semgrep.sarif

      - name: Upload scan reports
        uses: actions/upload-artifact@v4
        with:
          name: scan-reports
          path: reports/
          retention-days: 7

  ai-analysis:
    name: "ü§ñ AI Analysis"
    runs-on: ubuntu-latest
    needs: security-scan

    steps:
      - name: Checkout Repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Download Scan Reports
        uses: actions/download-artifact@v4
        with:
          name: scan-reports
          path: reports/

      - name: Setup Python (pip cache)
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: "pip"
          cache-dependency-path: |
            requirements.txt

      - name: Install Python Dependencies
        run: pip install -U pyyaml requests

      - name: Install Ollama
        run: |
          curl -fsSL https://ollama.com/install.sh | sh
          nohup ollama serve > /tmp/ollama.log 2>&1 &
          for i in {1..30}; do
            curl -sSf http://${{ env.OLLAMA_HOST }}/api/tags && break || sleep 2
          done

      - name: Pull Qwen Model
        run: ollama pull "${LLM_MODEL}"

      - name: Run AI Security Analysis
        continue-on-error: true
        run: |
          mkdir -p "${OUTPUT_DIR}"
          python main.py --analysis-only --model "${LLM_MODEL}" --ollama-url "${{ env.OLLAMA_URL }}" --verbose || true

      - name: Persist Analysis Output
        run: |
          RUN_ID=${GITHUB_RUN_ID}
          mkdir -p "${AUDIT_DIR}/run-${RUN_ID}"
          cp -r agent_output/* "${AUDIT_DIR}/run-${RUN_ID}/" || true

      - name: Upload Analysis Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ai-analysis-output
          path: agent_output/

      - name: Upload Audit (security-review)
        uses: actions/upload-artifact@v4
        with:
          name: security-review
          path: security-review/

  ai-fix-generation:
    name: "üîß AI Fix Generation"
    runs-on: ubuntu-latest
    needs: ai-analysis

    env:
      # enable optional LLM patch diffs
      LLM_AUTOFIX: "1"

    steps:
      - name: Checkout Repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Download Analysis Output
        uses: actions/download-artifact@v4
        with:
          name: ai-analysis-output
          path: agent_output/

      - name: Download Audit
        uses: actions/download-artifact@v4
        with:
          name: security-review
          path: security-review/

      - name: Download Scan Reports
        uses: actions/download-artifact@v4
        with:
          name: scan-reports
          path: reports/

      - name: Setup Python (pip cache)
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: "pip"
          cache-dependency-path: |
            requirements.txt

      - name: Install Dependencies
        run: pip install -U requests pyyaml

      - name: Install Ollama
        run: |
          curl -fsSL https://ollama.com/install.sh | sh
          nohup ollama serve > /tmp/ollama.log 2>&1 &
          for i in {1..30}; do
            curl -sSf http://${{ env.OLLAMA_HOST }}/api/tags && break || sleep 2
          done

      - name: Pull Qwen Model
        run: ollama pull "${LLM_MODEL}"

      - name: AI Generate Fix Patches (targeted)
        run: |
          mkdir -p agent_output/patches
          # targets.json is already in agent_output/ from ai-analysis artifact
          python main.py --generate-fixes --model "${LLM_MODEL}" --ollama-url "${{ env.OLLAMA_URL }}" --verbose --targets-path agent_output/targets.json || true

      - name: List generated patches
        run: |
          ls -la agent_output/patches || true
          echo "---- targets.json ----"
          test -f agent_output/targets.json && cat agent_output/targets.json || true
          echo "---- remediation_changes.txt ----"
          test -f agent_output/remediation_changes.txt && sed -n '1,200p' agent_output/remediation_changes.txt || echo "(no remediation_changes.txt)"

      - name: Inspect generated patches (first 40 lines)
        if: ${{ hashFiles('agent_output/patches/*.patch') != '' }}
        run: |
          for p in agent_output/patches/*.patch; do
            echo "---- $p (head) ----"
            sed -n '1,40p' "$p"
            echo
          done

      - name: Configure Git Identity
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Normalize patch line-endings (LF)
        if: ${{ hashFiles('agent_output/patches/*.patch') != '' }}
        run: sed -i 's/\r$//' agent_output/patches/*.patch || true

      - name: Apply Patches (safely)
        run: |
          set -e
          if compgen -G "agent_output/patches/*.patch" > /dev/null; then
            for p in agent_output/patches/*.patch; do
              echo ">>> Checking $p"
              git apply --check "$p" \
                || git apply --3way --whitespace=nowarn "$p" \
                || git apply --reject --whitespace=nowarn "$p" \
                || true
            done

            if compgen -G "*.rej" > /dev/null; then
              echo "Patch rejects found:"
              find . -name "*.rej" -print
            fi

            git add -A
            if ! git diff --cached --quiet; then
              git commit -m "AI Security Fixes (Patches)"
            else
              echo "No staged changes after applying patches."
            fi
          else
            echo "No patches found."
          fi

      - name: Open Pull Request to feature/AgentAI
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          branch: "security/fix-run-${{ github.run_id }}"
          base: "feature/AgentAI"
          title: "üîí AI Security Fixes (Run ${{ github.run_id }})"
          body: |
            ## üîí AI Security Fixes Generated

            - Model: ${{ env.LLM_MODEL }}
            - Targets recorded in `agent_output/targets.json`
            - Patches under `agent_output/patches/`
            - Full audit under `security-review/run-${{ github.run_id }}/`
            - Raw reports in `reports/`

            **Please review before merging.**
          add-paths: |
            security-review/**
            agent_output/**
            reports/**

  security-gate:
    name: "üö¶ Security Gate"
    runs-on: ubuntu-latest
    needs: ai-fix-generation

    steps:
      - name: Download AI Output
        uses: actions/download-artifact@v4
        with:
          name: ai-analysis-output
          path: agent_output/

      - name: Install jq
        run: |
          sudo apt-get update
          sudo apt-get install -y jq

      - name: Evaluate Security Decision
        run: |
          STATUS="pass"
          if [ -f agent_output/decision.json ]; then
            STATUS=$(jq -r '.status' agent_output/decision.json)
          fi
          echo "Final status: $STATUS"

          if [ "$STATUS" != "pass" ]; then
            echo "‚ùå Security gate FAILED ‚Äî Review PR"
            exit 1
          fi

          echo "‚úÖ Security gate PASSED"