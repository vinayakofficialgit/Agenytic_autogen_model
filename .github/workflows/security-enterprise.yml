name: "Enterprise Security Pipeline (AI-Driven)"

on:
  push:
    branches:
      - feature/AgentAI
  workflow_dispatch:

concurrency:
  group: security-enterprise-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: write
  pull-requests: write
  security-events: write

env:
  REPORTS_DIR: reports
  OUTPUT_DIR: agent_output
  APP_DIR: Order-app-main
  PYTHON_VERSION: 3.12

  LLM_MODEL: "qwen2.5-coder:3b"
  OLLAMA_URL: "http://127.0.0.1:11434"
  OLLAMA_HOST: "127.0.0.1:11434"
  OLLAMA_TEMP: 0.0

  MIN_SEVERITY: low

  TRIVY_CACHE_DIR: ~/.cache/trivy
  TRIVY_VERSION: "0.55.2"

# ============================================================
# 1Ô∏è‚É£ SECURITY SCAN
# ============================================================

jobs:
  security-scan:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: pip

      - run: mkdir -p "${REPORTS_DIR}"

      - run: |
          sudo apt-get update
          sudo apt-get install -y jq curl

      - run: python -m pip install --upgrade pip semgrep

      # -----------------------------
      # üîç SEMGREP (ENTERPRISE SAFE)
      # -----------------------------

      - name: Run Semgrep JSON
        run: |
          semgrep --config=auto \
            --exclude "reports/**" \
            --exclude "agent_output/**" \
            --exclude ".github/workflows/**" \
            --json . > "${REPORTS_DIR}/semgrep.json"

          EXIT_CODE=$?
          if [ $EXIT_CODE -gt 1 ]; then
            echo "‚ùå Semgrep execution error"
            exit $EXIT_CODE
          fi

      - name: Debug Semgrep Results
        run: |
          echo "Semgrep findings:"
          cat "${REPORTS_DIR}/semgrep.json" | jq '.results | length'

      - name: Run Semgrep SARIF
        run: |
          semgrep --config=auto \
            --exclude "reports/**" \
            --exclude "agent_output/**" \
            --exclude ".github/workflows/**" \
            --sarif . > "${REPORTS_DIR}/semgrep.sarif"

          EXIT_CODE=$?
          if [ $EXIT_CODE -gt 1 ]; then
            echo "‚ùå Semgrep SARIF error"
            exit $EXIT_CODE
          fi

      # -----------------------------
      # üîç TRIVY
      # -----------------------------

      - uses: actions/cache@v4
        with:
          path: ${{ env.TRIVY_CACHE_DIR }}
          key: trivy-db-${{ runner.os }}-${{ env.TRIVY_VERSION }}

      - name: Install Trivy
        run: |
          curl -sfL https://raw.githubusercontent.com/aquasecurity/trivy/main/contrib/install.sh \
          | sh -s -- -b /usr/local/bin "v${TRIVY_VERSION}"

      - name: Run Trivy FS
        run: |
          trivy fs \
            --cache-dir "${TRIVY_CACHE_DIR}" \
            --format json \
            --output "${REPORTS_DIR}/trivy_fs.json" \
            "${APP_DIR}"

          EXIT_CODE=$?
          if [ $EXIT_CODE -gt 1 ]; then
            echo "‚ùå Trivy execution error"
            exit $EXIT_CODE
          fi

      - uses: github/codeql-action/upload-sarif@v4
        with:
          sarif_file: reports/semgrep.sarif

      - uses: actions/upload-artifact@v4
        with:
          name: scan-reports
          path: reports/
          retention-days: 7

# ============================================================
# 2Ô∏è‚É£ AI ANALYSIS
# ============================================================

  ai-analysis:
    runs-on: ubuntu-latest
    needs: security-scan

    outputs:
      security_status: ${{ steps.decision.outputs.security_status }}

    steps:
      - uses: actions/checkout@v4

      - uses: actions/download-artifact@v4
        with:
          name: scan-reports
          path: reports/

      - uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: pip

      - run: pip install -U pyyaml requests

      # -----------------------------
      # ü§ñ OLLAMA
      # -----------------------------

      - uses: actions/cache@v4
        with:
          path: ~/.ollama
          key: ollama-${{ runner.os }}-${{ env.LLM_MODEL }}

      - name: Install Ollama
        run: |
          curl -fsSL https://ollama.com/install.sh | sh
          nohup ollama serve > /tmp/ollama.log 2>&1 &
          for i in {1..30}; do
            curl -sSf http://${{ env.OLLAMA_HOST }}/api/tags && break || sleep 2
          done

      - run: ollama pull "${LLM_MODEL}"

      # -----------------------------
      # üß† AI ANALYSIS
      # -----------------------------

      - name: Run AI Analysis
        run: |
          mkdir -p "${OUTPUT_DIR}"
          export LLM_VERBOSE=1
          python main.py --analysis-only

      - name: Debug Decision
        run: |
          cat agent_output/decision.json

      - name: Extract Decision Status
        id: decision
        run: |
          STATUS="pass"
          if [ -f agent_output/decision.json ]; then
            STATUS=$(jq -r '.status' agent_output/decision.json)
          fi
          echo "security_status=$STATUS" >> $GITHUB_OUTPUT

      - uses: actions/upload-artifact@v4
        with:
          name: ai-analysis-output
          path: agent_output/

# ============================================================
# 3Ô∏è‚É£ AI FIX GENERATION
# ============================================================

  ai-fix-generation:
    runs-on: ubuntu-latest
    needs: ai-analysis
    if: needs.ai-analysis.outputs.security_status == 'fail'

    steps:
      - uses: actions/checkout@v4

      - uses: actions/download-artifact@v4
        with:
          name: ai-analysis-output
          path: agent_output/

      - uses: actions/download-artifact@v4
        with:
          name: scan-reports
          path: reports/

      - uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: pip

      - run: pip install -U requests pyyaml

      - name: Generate Fixes
        run: |
          mkdir -p agent_output/patches
          python main.py --generate-fixes --skip-llm

      - name: Validate Patch Integrity
        run: |
          for p in agent_output/patches/*.patch; do
            git apply --check "$p"
          done

      - name: Apply Patches
        run: |
          for p in agent_output/patches/*.patch; do
            git apply --3way --whitespace=nowarn "$p"
          done
          git add -A
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git commit -m "AI Security Fixes" || true

      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          branch: "security/fix-run-${{ github.run_id }}"
          base: "feature/AgentAI"
          title: "üîí AI Security Fixes (Run ${{ github.run_id }})"
          body: |
            Hardened AI-generated security fixes.

# ============================================================
# 4Ô∏è‚É£ SECURITY GATE
# ============================================================

  security-gate:
    runs-on: ubuntu-latest
    needs: ai-analysis

    steps:
      - name: Enforce Gate
        run: |
          if [ "${{ needs.ai-analysis.outputs.security_status }}" != "pass" ]; then
            echo "‚ùå Security gate FAILED ‚Äî Vulnerabilities detected"
            exit 1
          fi
          echo "‚úÖ Security gate PASSED"