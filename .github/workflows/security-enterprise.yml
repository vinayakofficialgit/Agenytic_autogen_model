name: "Enterprise Security Pipeline (AI-Driven)"

on:
  push:
    branches:
      - feature/AgentAI
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write
  security-events: write

env:
  REPORTS_DIR: reports
  OUTPUT_DIR: agent_output
  AUDIT_DIR: security-review
  APP_DIR: Order-app-main
  PYTHON_VERSION: 3.12
  LLM_MODEL: "qwen2.5-coder:3b"
  OLLAMA_URL: "http://127.0.0.1:11434"
  OLLAMA_HOST: "127.0.0.1:11434"
  OLLAMA_NUM_CTX: 4096
  OLLAMA_NUM_PREDICT: 1024
  OLLAMA_TEMP: 0.1
  MIN_SEVERITY: low

jobs:
  # ------------------------------------------------------------
  # JOB 1: SECURITY SCAN
  # ------------------------------------------------------------
  security-scan:
    name: "üîç Security Scan"
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repo
        uses: actions/checkout@v4

      - name: Create reports directory
        run: mkdir -p "${REPORTS_DIR}"

      # -------------------------
      # Semgrep
      # -------------------------
      - name: Install Semgrep
        run: python3 -m pip install semgrep

      - name: Run Semgrep JSON scan
        run: |
          set -o pipefail
          semgrep --config=auto --json > "${REPORTS_DIR}/semgrep.json" || echo '{}' > "${REPORTS_DIR}/semgrep.json"

      - name: Run Semgrep SARIF scan
        run: |
          set -o pipefail
          semgrep --config=auto --sarif > "${REPORTS_DIR}/semgrep.sarif" || echo '{}' > "${REPORTS_DIR}/semgrep.sarif"

      # -------------------------
      # Trivy FS
      # -------------------------
      - name: Install Trivy
        run: |
          curl -sfL https://raw.githubusercontent.com/aquasecurity/trivy/main/contrib/install.sh \
          | sh -s -- -b /usr/local/bin
          trivy --version

      - name: Run Trivy FS Scan
        run: |
          set -o pipefail
          trivy fs --format json --output "${REPORTS_DIR}/trivy_fs.json" "${APP_DIR}" \
          || echo '{}' > "${REPORTS_DIR}/trivy_fs.json"

      # -------------------------
      # Trivy Image (conditional)
      # -------------------------
      - name: Run Trivy Image Scan
        run: |
          set -o pipefail
          if [ -f "${APP_DIR}/Dockerfile" ]; then
            docker build -t app-scan "${APP_DIR}"
            trivy image --format json --output "${REPORTS_DIR}/trivy_image.json" app-scan \
            || echo '{}' > "${REPORTS_DIR}/trivy_image.json"
          else
            echo '{}' > "${REPORTS_DIR}/trivy_image.json"
          fi

      # -------------------------
      # Gitleaks
      # -------------------------
      - name: Install Gitleaks
        run: |
          sudo apt-get update
          sudo apt-get install -y jq curl
          VERSION=$(curl -s https://api.github.com/repos/gitleaks/gitleaks/releases/latest | jq -r .tag_name)
          curl -sL "https://github.com/gitleaks/gitleaks/releases/download/${VERSION}/gitleaks_${VERSION#v}_linux_x64.tar.gz" | tar -xz
          sudo mv gitleaks /usr/local/bin/
          gitleaks version

      - name: Run Gitleaks (keep report even when leaks found)
        run: |
          set -o pipefail
          # IMPORTANT: don't overwrite report on exit code != 0
          gitleaks detect --source . --no-git --report-format json \
            --report-path "${REPORTS_DIR}/gitleaks.json" \
            || true
          # Ensure file exists
          test -f "${REPORTS_DIR}/gitleaks.json" || echo '[]' > "${REPORTS_DIR}/gitleaks.json"

      # -------------------------
      # Conftest (guarded)
      # -------------------------
      - name: Install Conftest
        run: |
          sudo apt-get update
          sudo apt-get install -y jq curl
          VERSION=$(curl -s https://api.github.com/repos/open-policy-agent/conftest/releases/latest | jq -r .tag_name)
          curl -sL "https://github.com/open-policy-agent/conftest/releases/download/${VERSION}/conftest_${VERSION#v}_Linux_x86_64.tar.gz" | tar -xz
          sudo mv conftest /usr/local/bin/
          conftest --version

      - name: Run Conftest (only if policy dirs exist)
        run: |
          set -o pipefail
          targets=""
          for d in k8s terraform policy; do
            [ -d "$d" ] && targets="$targets $d"
          done

          if [ -n "$targets" ]; then
            # Capture stderr so rego parse errors are visible in artifacts
            conftest test $targets --output json > "${REPORTS_DIR}/conftest.json" 2> "${REPORTS_DIR}/conftest.err" || true
            test -s "${REPORTS_DIR}/conftest.json" || echo '[]' > "${REPORTS_DIR}/conftest.json"
          else
            echo '[]' > "${REPORTS_DIR}/conftest.json"
            echo "No policy targets found." > "${REPORTS_DIR}/conftest.err"
          fi

      # -------------------------
      # Diagnostics + Publishing
      # -------------------------
      - name: Show Reports
        run: |
          echo "Reports generated:"
          ls -la "${REPORTS_DIR}"
          echo "Report sizes:"
          wc -c "${REPORTS_DIR}"/* || true

      - name: Upload Semgrep SARIF to Code Scanning
        uses: github/codeql-action/upload-sarif@v4
        with:
          sarif_file: reports/semgrep.sarif

      - name: Upload scan reports
        uses: actions/upload-artifact@v4
        with:
          name: scan-reports
          path: reports/
          retention-days: 7

  # ------------------------------------------------------------
  # JOB 2: AI ANALYSIS (NO PATCHING)
  # ------------------------------------------------------------
  ai-analysis:
    name: "ü§ñ AI Analysis"
    runs-on: ubuntu-latest
    needs: security-scan

    steps:
      - name: Checkout Repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Download Scan Reports
        uses: actions/download-artifact@v4
        with:
          name: scan-reports
          path: reports/

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install Python Dependencies
        run: pip install pyyaml requests

      - name: Install Ollama
        run: |
          set -o pipefail
          curl -fsSL https://ollama.com/install.sh | sh
          nohup ollama serve > /tmp/ollama.log 2>&1 &
          for i in {1..30}; do
            curl -sSf http://${{ env.OLLAMA_HOST }}/api/tags && break || sleep 2
          done

      - name: Pull Qwen Model
        run: ollama pull "${LLM_MODEL}"

      - name: Run AI Security Analysis
        continue-on-error: true
        run: |
          set -o pipefail
          mkdir -p "${OUTPUT_DIR}"
          python main.py --analysis-only --model "${LLM_MODEL}" --ollama-url "${{ env.OLLAMA_URL }}" --verbose \
            2>&1 | tee "${OUTPUT_DIR}/analysis.log" || true

      - name: Show Ollama log (debug)
        if: always()
        run: |
          echo "---- /tmp/ollama.log ----"
          tail -n 200 /tmp/ollama.log || true

      - name: Persist Analysis Output
        run: |
          RUN_ID=${GITHUB_RUN_ID}
          mkdir -p "${AUDIT_DIR}/run-${RUN_ID}"
          cp -r agent_output/* "${AUDIT_DIR}/run-${RUN_ID}/" || true

      - name: Upload Analysis Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ai-analysis-output
          path: agent_output/

      - name: Upload Audit (security-review)
        uses: actions/upload-artifact@v4
        with:
          name: security-review
          path: security-review/

  # ------------------------------------------------------------
  # JOB 3: AI FIX GENERATION
  # ------------------------------------------------------------
  ai-fix-generation:
    name: "üîß AI Fix Generation"
    runs-on: ubuntu-latest
    needs: ai-analysis

    steps:
      - name: Checkout Repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Download Analysis Output
        uses: actions/download-artifact@v4
        with:
          name: ai-analysis-output
          path: agent_output/

      - name: Download Audit
        uses: actions/download-artifact@v4
        with:
          name: security-review
          path: security-review/

      - name: Download Scan Reports
        uses: actions/download-artifact@v4
        with:
          name: scan-reports
          path: reports/

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install Dependencies
        run: pip install requests pyyaml jq

      - name: Install Ollama
        run: |
          set -o pipefail
          curl -fsSL https://ollama.com/install.sh | sh
          nohup ollama serve > /tmp/ollama.log 2>&1 &
          for i in {1..30}; do
            curl -sSf http://${{ env.OLLAMA_HOST }}/api/tags && break || sleep 2
          done

      - name: Pull Qwen Model
        run: ollama pull "${LLM_MODEL}"

      - name: Ensure targets.json exists (strict allow-list)
        run: |
          set -e
          test -f agent_output/targets.json
          echo "targets.json:"
          sed -n '1,160p' agent_output/targets.json

      - name: AI Generate Fix Patches
        run: |
          set -o pipefail
          mkdir -p agent_output/patches
          python main.py --generate-fixes --model "${LLM_MODEL}" --ollama-url "${{ env.OLLAMA_URL }}" --verbose \
            2>&1 | tee "${OUTPUT_DIR}/fix.log" || true

      - name: Show Ollama log (debug)
        if: always()
        run: |
          echo "---- /tmp/ollama.log ----"
          tail -n 200 /tmp/ollama.log || true

      - name: List generated patches
        run: |
          ls -la agent_output/patches || true
          echo "---- remediation_changes.txt ----"
          test -f agent_output/remediation_changes.txt && sed -n '1,160p' agent_output/remediation_changes.txt || echo "(no remediation_changes.txt)"
          echo "---- decision.json .remediation.files ----"
          test -f agent_output/decision.json && jq -r '.remediation.files // empty' agent_output/decision.json || true

      - name: Inspect generated patches (first 40 lines)
        if: ${{ hashFiles('agent_output/patches/*.patch') != '' }}
        run: |
          for p in agent_output/patches/*.patch; do
            echo "---- $p (head) ----"
            sed -n '1,40p' "$p"
            echo
          done

      - name: Configure Git Identity
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Normalize patch line-endings (LF)
        if: ${{ hashFiles('agent_output/patches/*.patch') != '' }}
        run: sed -i 's/\r$//' agent_output/patches/*.patch || true

      - name: Apply Patches (safely)
        run: |
          set -e
          if compgen -G "agent_output/patches/*.patch" > /dev/null; then
            for p in agent_output/patches/*.patch; do
              echo ">>> Checking $p"
              git apply --check "$p" \
                || git apply --3way --whitespace=nowarn "$p" \
                || git apply --reject --whitespace=nowarn "$p" \
                || true
            done

            if compgen -G "*.rej" > /dev/null; then
              echo "Patch rejects found:"
              find . -name "*.rej" -print
            fi

            git add -A
            if ! git diff --cached --quiet; then
              git commit -m "AI Security Fixes (Patches)"
            else
              echo "No staged changes after applying patches."
            fi
          else
            echo "No patches found."
          fi

      - name: Open Pull Request to feature/AgentAI
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          branch: "security/fix-run-${{ github.run_id }}"
          base: "feature/AgentAI"
          title: "üîí AI Security Fixes (Run ${{ github.run_id }})"
          body: |
            ## üîí AI Security Fixes Generated

            - Model: ${{ env.LLM_MODEL }}
            - Strict target allow-list: `agent_output/targets.json`
            - Patches (if any): `agent_output/patches/`
            - Full audit: `security-review/run-${{ github.run_id }}/`
            - Raw reports: `reports/`

            **Please review before merging.**
          add-paths: |
            security-review/**
            agent_output/**
            reports/**

  # ------------------------------------------------------------
  # JOB 4: SECURITY GATE
  # ------------------------------------------------------------
  security-gate:
    name: "üö¶ Security Gate"
    runs-on: ubuntu-latest
    needs: ai-fix-generation

    steps:
      - name: Download AI Output
        uses: actions/download-artifact@v4
        with:
          name: ai-analysis-output
          path: agent_output/

      - name: Install jq
        run: |
          sudo apt-get update
          sudo apt-get install -y jq

      - name: Evaluate Security Decision
        run: |
          STATUS="pass"
          if [ -f agent_output/decision.json ]; then
            STATUS=$(jq -r '.status' agent_output/decision.json)
          fi
          echo "Final status: $STATUS"

          if [ "$STATUS" != "pass" ]; then
            echo "‚ùå Security gate FAILED ‚Äî Review PR"
            exit 1
          fi

          echo "‚úÖ Security gate PASSED"